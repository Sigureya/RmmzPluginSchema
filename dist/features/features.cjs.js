"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const m=require("../shared/constants.cjs.js"),_=(r,a)=>{if(r.length!==0)return`${a}[${r.map(e=>`"${e.name}"`).join(",")}]`},T=(r,a)=>r.map(e=>({path:`${a}["${e.name}"][*]`,param:e})),A={undefinedStruct:"undefined_struct",cyclicStruct:"cyclic_struct"};function J(r,a,e){if(r.frames.length===0)return r;const t=r.frames[r.frames.length-1],s=r.frames.slice(0,-1);if(t.ancestry.includes(t.schemaName))return{frames:s,items:r.items,errs:[...r.errs,{code:e.cyclicStruct,path:t.basePath}]};const c=a.get(t.schemaName);if(!c)return{frames:s,items:r.items,errs:[...r.errs,{code:e.undefinedStruct,path:t.basePath}]};const o=function(u,i){const p=u.ancestry.concat(u.schemaName),d=u.basePath;return[...i.structs.map(l=>({schemaName:l.attr.struct,basePath:`${d}["${l.name}"]`,ancestry:p})),...i.structArrays.map(l=>({schemaName:l.attr.struct,basePath:`${d}["${l.name}"][*]`,ancestry:p}))].reverse()}(t,c);if(c.scalars.length>0||c.scalarArrays.length>0){const u=function(i,{path:p,structName:d}){return{category:"struct",objectSchema:m.toObjectPluginParams(i.scalars),name:d,scalarArrays:T(i.scalarArrays,p),scalarsPath:i.scalars.length>0?_(i.scalars,p):void 0}}(c,{path:t.basePath,structName:t.schemaName});return s.push(...o),{frames:s,items:[...r.items,u],errs:r.errs}}return s.push(...o),{frames:s,items:r.items,errs:r.errs}}function b(r,a,e,t){const s={items:[],errs:[],frames:[{schemaName:r,basePath:a,ancestry:[]}]},c=Math.max(1,3*e.size+5),o=Array.from({length:c}).reduce(u=>u.frames.length===0?u:J(u,e,t),s);return{items:o.items,errors:o.errs}}const Y=(r,a,e,t=A)=>b(r.attr.struct,`${a}["${r.name}"]`,e,t),M=(r,a,e,t=A)=>b(r.attr.struct,`${a}["${r.name}"][*]`,e,t),y=(r,a,e,t)=>m.isStructAttr(e)?W(r,e,t):m.isStructArrayAttr(e)?U(r,e,t):m.isArrayAttr(e)?L(r,a,e):K(r,a,e),L=(r,a,e)=>({rootCategory:r,rootName:a,scalars:{name:"",objectSchema:{},scalarsPath:void 0,scalarArrays:[{path:`$["${e.name}"][*]`,param:e}]},structs:{items:[],errors:[]},structArrays:{items:[],errors:[]}}),K=(r,a,e)=>({rootCategory:r,rootName:a,scalars:{name:e.attr.kind,objectSchema:{[e.name]:e.attr},scalarsPath:`$["${e.name}"]`,scalarArrays:[]},structArrays:{items:[],errors:[]},structs:{items:[],errors:[]}}),W=(r,a,e)=>({rootName:a.name,rootCategory:r,scalars:void 0,structArrays:{items:[],errors:[]},structs:Y(a,"$",e)}),U=(r,a,e)=>({structArrays:M(a,"$",e),rootName:a.name,rootCategory:r,scalars:void 0,structs:{items:[],errors:[]}}),I=(r,a,e,t)=>a.filter(s=>typeof s=="number").map(s=>({rootName:r.rootName,rootType:r.rootCategory,value:s,structName:e,param:t})),w=(r,a,e,t)=>a.filter(s=>typeof s=="string").map(s=>({rootName:r.rootName,rootType:r.rootCategory,value:s,structName:e,param:t})),G=(r,a,e,t,s)=>{if(typeof e=="object"||e===null)return null;const c=t[t.length-1];if(typeof c=="number")return null;const o=s[c];return o?{rootName:r.rootName,rootType:r.rootCategory,structName:a,value:e,param:{name:c,attr:o}}:null},v=(r,a)=>a.map(e=>q(r,e)).flat(3),q=(r,a)=>[a.top?P(a,r,a.top,""):[],a.structs.map(e=>P(a,r,e)),a.structArrays.map(e=>P(a,r,e))],P=(r,a,e,t=e.bundleName)=>{const s=e.scalar?((o,u,i,p,d)=>p.pathSegments(i).map(({value:l,segments:h})=>G(o,u,l,h,d)).filter(l=>l!==null))(r,t,a,e.scalar.jsonPathJS,e.scalar.record):[],c=e.arrays.map(o=>((u,i,p,d)=>{const l=d.jsonPathJS.find(p);if(!Array.isArray(l))return[];const h=d.schema.attr;return m.isStringArrayParam(h)?w(u,l,i,d.schema):m.isNumberArrayParam(h)?I(u,l,i,d.schema):[]})(r,t,a,o));return[s,c].flat(2)},S=(r,a)=>{const e=r.scalars?N(r.scalars,a):void 0,t=r.structs.items.map(c=>N(c,a)),s=r.structArrays.items.map(c=>N(c,a));return{rootCategory:r.rootCategory,rootName:r.rootName,top:e,structs:t,structArrays:s}},N=(r,a)=>r.scalarsPath?{bundleName:r.name,arrays:x(r.scalarArrays,r.name,a),scalar:z(r.scalarsPath,r.objectSchema,a)}:{bundleName:r.name,arrays:x(r.scalarArrays,r.name,a)},x=(r,a,e)=>r.map(t=>({jsonPathJS:e(t.path),schema:t.param,parentType:a})),z=(r,a,e)=>({jsonPathJS:e(r),record:a}),E=(r,a,e,t)=>({pluginName:r,commandName:a.command,desc:a.desc??"",text:a.text??"",extractors:H(a,e,t)}),H=(r,a,e)=>r.args.map(t=>{const s=y("args",r.command,t,a);return S(s,e)}),R=(r,a)=>({pluginName:a.pluginName,commandName:a.commandName,args:v(r,a.extractors)}),O=(r,a)=>{const e=m.createClassifiedStructMap(r.schema.structs);return r.schema.commands.map(t=>[`${r.pluginName}:${t.command}`,E(r.pluginName,t,e,a)])},k=(r,a)=>{const e=m.parseDeepRecord(r.parameters);return{pluginName:r.name,params:v(e,a)}},C=(r,a,e)=>{const t=m.createClassifiedStructMap(a.structs);return{pluginName:r,params:Q(a,t,e),commands:j(r,a.commands,t,e)}},Q=(r,a,e)=>r.params.map(t=>{const s=y("param",t.name,t,a);return S(s,e)}),j=(r,a,e,t)=>a.map(s=>[`${r}:${s.command}`,E(r,s,e,t)]),n=(r,a)=>`@${r} ${a}`,f=(r,a)=>{const e=r[a];return e===void 0?void 0:n(a,String(e))},B=(r,a,e)=>{const t=n(a,r.name),s=X(r.attr),c=Z(r.attr,e);return c?{name:t,base:s,default:c.default,attr:c.attr.filter(o=>o!==void 0)}:{name:t,base:s,default:void 0,attr:[]}},X=r=>{return{kind:(a=r,a.kind==="struct"?n(m.KEYWORD_TYPE,`struct<${a.struct}>`):a.kind==="struct[]"?n(m.KEYWORD_TYPE,`struct<${a.struct}>[]`):n(m.KEYWORD_TYPE,a.kind)),desc:r.desc?n("desc",r.desc):void 0,text:r.text?n("text",r.text):void 0,parent:r.parent?n("parent",r.parent):void 0};var a},Z=(r,a)=>r.kind==="number"?tr(r):r.kind==="number[]"?sr(r,a):r.kind==="file[]"?or(r,a):r.kind==="struct[]"?dr(r,a):r.kind==="string[]"||r.kind==="multiline_string[]"?nr(r,a):r.kind==="select"?ur(r):r.kind==="combo"?lr(r):r.kind==="file"?cr(r):r.kind==="struct"?ir(r,a):r.kind==="boolean"?rr(r):r.kind==="string"||r.kind==="any"||r.kind==="multiline_string"?mr(r):typeof r.default=="number"?ar(r):er(r,a),F=r=>r===void 0?void 0:n("default",r.toString()),rr=r=>({attr:g.boolean.map(a=>f(r,a)),default:n("default",r.default?"true":"false")}),ar=r=>({attr:[],default:F(r.default)}),er=(r,a)=>{const e=a.numberArray(r.default);return{attr:[],default:n("default",e)}},tr=r=>({attr:g.number.map(a=>f(r,a)),default:F(r.default)}),sr=(r,a)=>{const e=a.numberArray(r.default);return{attr:g.number.map(t=>f(r,t)),default:n("default",e)}},nr=(r,a)=>{const e=a.stringArray(r.default);return{attr:[],default:n("default",e)}},mr=r=>({attr:[],default:n("default",r.default)}),cr=r=>({attr:g.file.map(a=>f(r,a)),default:n("default",r.default)}),or=(r,a)=>{const e=a.stringArray(r.default);return{attr:g.file.map(t=>f(r,t)),default:n("default",e)}},ur=r=>{return{attr:(a=r,a.options.flatMap(e=>[n(m.KEYWORD_OPTION,e.option),n(m.KEYWORD_VALUE,e.value)])),default:n("default",r.default)};var a},lr=r=>{return{attr:(a=r,a.options.map(e=>n(m.KEYWORD_OPTION,e))),default:n("default",r.default)};var a},ir=(r,a)=>{if(!r.default)return{attr:[],default:void 0};const e=a.struct(r.default);return{attr:[],default:n("default",e)}},dr=(r,a)=>{if(!r.default)return{attr:[],default:n("default","[]")};const e=a.structArray(r.default);return{attr:[],default:n("default",e)}},g={number:["min","max","decimals"],file:["dir"],boolean:["on","off"]},pr=(r,a)=>({params:V(r.params,a),structs:r.structs.map(e=>fr(e,a)),commands:r.commands.map(e=>gr(e,a))}),V=(r,a)=>r.map(e=>B(e,"param",a)),fr=(r,a)=>({struct:r.struct,params:V(r.params,a)}),gr=(r,a)=>({desc:r.desc?n("desc",r.desc):void 0,text:r.text?n("text",r.text):void 0,command:n("command",r.command),args:r.args.map(e=>B(e,"arg",a))}),hr=r=>{const a=r.params.flatMap($).filter(e=>e!==void 0);return[`/*~struct~${r.struct}:${r.locale??""}`,...a,"*/"]},yr=r=>{const a=[r.target,r.meta.author,r.meta.pluginDesc,r.meta.url,"",...r.dependencies.base,...r.dependencies.orderBefore,...r.dependencies.orderAfter,(e=r.dependencies,e.base.length>0||e.orderBefore.length>0||e.orderAfter.length>0?"":void 0),...r.schema.commands.flatMap(Pr),...r.schema.params.flatMap($)].filter(t=>t!==void 0);var e;return[`/*:${r.locale??""}`,...a,"*/"]},Pr=r=>[r.command,r.text,r.desc,...r.args.flatMap($)],$=r=>[r.name,r.base.kind,r.base.desc,r.base.text,r.base.parent,...r.attr,r.default,""],D=(r,a)=>({locale:r.locale,schema:pr(r.schema,a),target:n(m.KEYWORD_TARGET,r.target),meta:Ar(r.meta),dependencies:Nr(r.dependencies)}),Nr=r=>({base:r.base.map(a=>n(m.KEYWORD_BASE,a)),orderBefore:r.orderBefore.map(a=>n(m.KEYWORD_ORDERBEFORE,a)),orderAfter:r.orderAfter.map(a=>n(m.KEYWORD_ORDERAFTER,a))}),Ar=r=>{const a=r.author,e=r.plugindesc,t=r.url;return{author:a?n(m.KEYWORD_AUTHOR,a):void 0,pluginDesc:e?n(m.KEYWORD_PLUGINDESC,e):void 0,url:t?n(m.KEYWORD_URL,t):void 0}};exports.compileCommandExtractorsFromPlugins=(r,a)=>new Map(r.flatMap(e=>O(e,a))),exports.compilePluginCommandExtractor=E,exports.compilePluginCommandPairs=O,exports.compilePluginParamExtractor=(r,a,e)=>({pluginName:r.pluginName,extractors:r.schema.params.map(t=>{const s=y("param","plugin",t,a);return S(s,e)})}),exports.convertPlugin=(r,a,e)=>{const t=C(r.pluginName,r.schema,e),{params:s}=k(a,t.params);return{record:a,schema:r,extractorEntries:t.commands,params:s}},exports.createPluginCommandExtractor=(r,a)=>{const e=m.createClassifiedStructMap(r.schema.structs);return j(r.pluginName,r.schema.commands,e,a)},exports.createPluginValueExtractor=C,exports.createPluginValuesPath=y,exports.createPrimiteveParamPath=K,exports.createStructParamPath=(r,a,e)=>W(r,a,e),exports.extractCommandArgsByKey=(r,a,e)=>{const t=e.get(a);if(t)return R(r,t)},exports.extractPluginCommandArgs=R,exports.extractPluginParam=(r,a)=>({pluginName:a.pluginName,params:v(r,a.extractors)}),exports.extractPluginParamFromRecord=k,exports.generatePluginAnnotation=D,exports.generatePluginAnnotationLines=(r,a)=>{const e=D(r,a);return{body:yr(e),structs:e.schema.structs.map(hr)}},exports.getPathFromStructArraySchema=M,exports.getPathFromStructParam=Y,exports.getPathFromStructSchema=(r,a,e,t=A)=>b(r,a,e,t),exports.isCommandArgValue=r=>r.rootType==="args",exports.ispluginParamValue=r=>r.rootType==="param",exports.makeScalarArrayPath=T,exports.makeScalarValuesPath=_,exports.mergeCommandMap=r=>{const a=r.flatMap(e=>e.extractorEntries);return new Map(a)};
