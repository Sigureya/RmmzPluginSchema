"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const h=require("../shared/structMap.cjs.js"),F=(a,t)=>{if(a.length!==0)return`${t}[${a.map(r=>`"${r.name}"`).join(",")}]`},J=(a,t)=>a.map(r=>({path:`${t}.${r.name}[*]`,param:r})),N={undefinedStruct:"undefined_struct",cyclicStruct:"cyclic_struct"};function q(a,{path:t,structName:r}){return{category:"struct",objectSchema:h.toObjectPluginParams(a.scalars),name:r,scalarArrays:J(a.scalarArrays,t),scalarsPath:a.scalars.length>0?F(a.scalars,t):void 0}}function A(a,t,r,e){const s={items:[],errs:[],frames:[{schemaName:a,basePath:t,ancestry:[]}]},o=Math.max(1,3*r.size+5),u=Array.from({length:o}).reduce(l=>l.frames.length===0?l:function(m,p,i){if(m.frames.length===0)return m;const c=m.frames[m.frames.length-1],n=m.frames.slice(0,-1);if(c.ancestry.includes(c.schemaName))return{frames:n,items:m.items,errs:[...m.errs,{code:i.cyclicStruct,path:c.basePath}]};const y=p.get(c.schemaName);if(!y)return{frames:n,items:m.items,errs:[...m.errs,{code:i.undefinedStruct,path:c.basePath}]};const b=function(g,C){const v=g.ancestry.concat(g.schemaName),j=g.basePath;return[...C.structs.map(d=>({schemaName:d.attr.struct,basePath:`${j}.${d.name}`,ancestry:v})),...C.structArrays.map(d=>({schemaName:d.attr.struct,basePath:`${j}.${d.name}[*]`,ancestry:v}))].reverse()}(c,y);if(y.scalars.length>0||y.scalarArrays.length>0){const g=q(y,{path:c.basePath,structName:c.schemaName});return n.push(...b),{frames:n,items:[...m.items,g],errs:m.errs}}return n.push(...b),{frames:n,items:m.items,errs:m.errs}}(l,r,e),s);return{items:u.items,errors:u.errs}}const k=(a,t,r,e=N)=>A(a.attr.struct,`${t}.${a.name}`,r,e),E=(a,t,r,e=N)=>A(a.attr.struct,`${t}.${a.name}[*]`,r,e),S=(a,t,r,e)=>h.isStructAttr(r)?O(a,r,e):h.isStructArrayAttr(r)?z(a,r,e):h.isArrayAttr(r)?w(a,t,r):V(a,t,r),w=(a,t,r)=>({rootCategory:a,rootName:t,scalars:{category:a,name:"array",objectSchema:{},scalarsPath:void 0,scalarArrays:[{path:`$.${r.name}[*]`,param:r}]},structs:{items:[],errors:[]},structArrays:{items:[],errors:[]}}),V=(a,t,r)=>({rootCategory:a,rootName:t,scalars:{category:"primitive",name:r.attr.kind,objectSchema:{[r.name]:r.attr},scalarsPath:`$.${r.name}`,scalarArrays:[]},structArrays:{items:[],errors:[]},structs:{items:[],errors:[]}}),O=(a,t,r)=>({rootName:t.name,rootCategory:a,scalars:void 0,structArrays:{items:[],errors:[]},structs:k(t,"$",r)}),z=(a,t,r)=>({structArrays:E(t,"$",r),rootName:t.name,rootCategory:a,scalars:void 0,structs:{items:[],errors:[]}}),B=(a,t,r,e)=>t.filter(s=>typeof s=="number").map(s=>({roootName:a.rootName,rootType:a.rootCategory,value:s,category:"struct",name:r,param:e})),K=(a,t,r,e)=>t.filter(s=>typeof s=="string").map(s=>({roootName:a.rootName,rootType:a.rootCategory,value:s,category:"struct",name:r,param:e})),D=(a,t,r,e,s)=>{if(typeof r=="object"||r===null)return null;const o=e[e.length-1];if(typeof o=="number")return null;const u=s[o];return u?{roootName:a.rootName,rootType:a.rootCategory,category:"struct",name:t,value:r,param:{name:o,attr:u}}:null},G=(a,t)=>t.map(r=>H(a,r)).flat(3),H=(a,t)=>[t.top?f(t,a,t.top):[],t.structs.map(r=>f(t,a,r)),t.structArrays.map(r=>f(t,a,r))],f=(a,t,r)=>{const e=r.bundleName,s=r.scalar?((u,l,m,p,i)=>p.pathSegments(m).map(({value:c,segments:n})=>D(u,l,c,n,i)).filter(c=>c!==null))(a,e,t,r.scalar.jsonPathJS,r.scalar.record):[],o=r.arrays.map(u=>((l,m,p,i)=>{const c=i.jsonPathJS.find(p);if(!Array.isArray(c))return[];const n=i.schema.attr;return h.isStringArrayParam(n)?K(l,c,m,i.schema):h.isNumberArrayParam(n)?B(l,c,m,i.schema):[]})(a,e,t,u));return[s,o].flat(2)},_=(a,t)=>{const r=a.scalars?P(a.scalars,t):void 0,e=a.structs.items.map(o=>P(o,t)),s=a.structArrays.items.map(o=>P(o,t));return{rootCategory:a.rootCategory,rootName:a.rootName,top:r,structs:e,structArrays:s}},P=(a,t)=>a.scalarsPath?{bundleName:a.name,arrays:x(a.scalarArrays,a.name,t),scalar:I(a.scalarsPath,a.objectSchema,t)}:{bundleName:a.name,arrays:x(a.scalarArrays,a.name,t)},x=(a,t,r)=>a.map(e=>({jsonPathJS:r(e.path),schema:e.param,parentType:t})),I=(a,t,r)=>({jsonPathJS:r(a),record:t}),$=(a,t,r,e)=>({pluginName:a,commandName:t.command,desc:t.desc??"",text:t.text??"",extractors:L(t,r,e)}),L=(a,t,r)=>a.args.map(e=>{const s=S("args",a.command,e,t);return _(s,r)}),M=(a,t)=>({pluginName:t.pluginName,commandName:t.commandName,args:G(a,t.extractors)}),T=(a,t)=>{const r=h.createClassifiedStructMap(a.schema.structs);return a.schema.commands.map(e=>[`${a.pluginName}:${e.command}`,$(a.pluginName,e,r,t)])},Q=(a,t,r)=>a.params.map(e=>{const s=S("param",e.name,e,t);return _(s,r)}),R=(a,t,r,e)=>t.map(s=>[`${a}:${s.command}`,$(a,s,r,e)]);exports.compileCommandExtractorsFromPlugins=(a,t)=>new Map(a.flatMap(r=>T(r,t))),exports.compilePluginCommandExtractor=$,exports.compilePluginCommandPairs=T,exports.createPluginValueExtractor=(a,t,r)=>{const e=h.createClassifiedStructMap(t.structs);return{params:Q(t,e,r),commands:R(a,t.commands,e,r)}},exports.createPluginValuesPath=S,exports.createPrimiteveParamPath=V,exports.createStructParamPath=(a,t,r)=>O(a,t,r),exports.extractCommandArgsByKey=(a,t,r)=>{const e=r.get(t);if(e)return M(a,e)},exports.extractPluginCommandArgs=M,exports.getPathFromStructArraySchema=E,exports.getPathFromStructParam=k,exports.getPathFromStructSchema=(a,t,r,e=N)=>A(a,t,r,e),exports.makeScalarArrayPath=J,exports.makeScalarValuesPath=F;
