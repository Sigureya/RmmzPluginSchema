"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const l=require("../shared/structMap.cjs.js"),M=(a,t)=>{if(a.length!==0)return`${t}[${a.map(e=>`"${e.name}"`).join(",")}]`},J=(a,t)=>a.map(e=>({path:`${t}.${e.name}[*]`,param:e})),d={undefinedStruct:"undefined_struct",cyclicStruct:"cyclic_struct"};function _(a,{path:t,structName:e}){return{category:"struct",objectSchema:l.toObjectPluginParams(a.scalars),name:e,scalarArrays:J(a.scalarArrays,t),scalarsPath:a.scalars.length>0?M(a.scalars,t):void 0}}function N(a,t,e,r){const m={items:[],errs:[],frames:[{schemaName:a,basePath:t,ancestry:[]}]},s=Math.max(1,3*e.size+5),o=Array.from({length:s}).reduce(n=>n.frames.length===0?n:function(c,u,A){if(c.frames.length===0)return c;const i=c.frames[c.frames.length-1],p=c.frames.slice(0,-1);if(i.ancestry.includes(i.schemaName))return{frames:p,items:c.items,errs:[...c.errs,{code:A.cyclicStruct,path:i.basePath}]};const y=u.get(i.schemaName);if(!y)return{frames:p,items:c.items,errs:[...c.errs,{code:A.undefinedStruct,path:i.basePath}]};const S=function(h,b){const $=h.ancestry.concat(h.schemaName),v=h.basePath;return[...b.structs.map(g=>({schemaName:g.attr.struct,basePath:`${v}.${g.name}`,ancestry:$})),...b.structArrays.map(g=>({schemaName:g.attr.struct,basePath:`${v}.${g.name}[*]`,ancestry:$}))].reverse()}(i,y);if(y.scalars.length>0||y.scalarArrays.length>0){const h=_(y,{path:i.basePath,structName:i.schemaName});return p.push(...S),{frames:p,items:[...c.items,h],errs:c.errs}}return p.push(...S),{frames:p,items:c.items,errs:c.errs}}(n,e,r),m);return{items:o.items,errors:o.errs}}const O=(a,t,e,r=d)=>{const m=a.map(s=>N(s.attr.struct,`${t}.${s.name}`,e,r));return{items:m.flatMap(s=>s.items),errors:m.flatMap(s=>s.errors)}},T=(a,t,e,r=d)=>{const m=a.map(s=>N(s.attr.struct,`${t}.${s.name}[*]`,e,r));return{items:m.flatMap(s=>s.items),errors:m.flatMap(s=>s.errors)}},F=(a,t,e,r)=>l.isStructAttr(e)?V(a,e,r):l.isStructArrayAttr(e)?w(a,e,r):l.isArrayAttr(e)?q(a,t,e):k(a,t,e),q=(a,t,e)=>({rootCategory:a,rootName:t,scalars:{category:a,name:"array",objectSchema:{},scalarsPath:void 0,scalarArrays:[{path:`$.${e.name}[*]`,param:e}]},structs:{items:[],errors:[]},structArrays:{items:[],errors:[]}}),k=(a,t,e)=>({rootCategory:a,rootName:t,scalars:{category:"primitive",name:e.attr.kind,objectSchema:{[e.name]:e.attr},scalarsPath:`$.${e.name}`,scalarArrays:[]},structArrays:{items:[],errors:[]},structs:{items:[],errors:[]}}),V=(a,t,e)=>({rootName:t.name,rootCategory:a,scalars:void 0,structArrays:{items:[],errors:[]},structs:O([t],"$",e)}),w=(a,t,e)=>({structArrays:T([t],"$",e),rootName:t.name,rootCategory:a,scalars:void 0,structs:{items:[],errors:[]}}),z=(a,t)=>t.map(e=>B(a,e)).flat(3),B=(a,t)=>[t.top?f(t,a,t.top):[],t.structs.map(e=>f(t,a,e)),t.structArrays.map(e=>f(t,a,e))],f=(a,t,e)=>{const r=e.bundleName;return[e.scalar?K(a,r,t,e.scalar.jsonPathJS,e.scalar.record):[],e.arrays.map(m=>W(a,r,t,m))].flat(2)},K=(a,t,e,r,m)=>r.pathSegments(e).reduce((s,{value:o,segments:n})=>{if(typeof o=="object")return s;const c=n[n.length-1];if(typeof c=="number")return s;const u=m[c];return u&&s.push({roootName:a.rootName,rootType:a.rootCategory,category:"struct",name:t,value:o,param:{name:c,attr:u}}),s},[]),W=(a,t,e,r)=>{const m=r.jsonPathJS.find(e);if(!Array.isArray(m))return[];const s=r.schema.attr;return l.isStringArrayParam(s)?m.filter(o=>typeof o=="string").map(o=>({value:o,category:"struct",rootType:a.rootCategory,roootName:a.rootName,name:t,param:r.schema})):l.isNumberArrayParam(s)?m.filter(o=>typeof o=="number").map(o=>({roootName:a.rootName,rootType:a.rootCategory,value:o,category:"struct",name:t,param:r.schema})):[]},P=(a,t)=>a.scalarsPath?{bundleName:a.name,arrays:j(a.scalarArrays,a.name,t),scalar:D(a.scalarsPath,a.objectSchema,t)}:{bundleName:a.name,arrays:j(a.scalarArrays,a.name,t)},j=(a,t,e)=>a.map(r=>({jsonPathJS:e(r.path),schema:r.param,parentType:t})),D=(a,t,e)=>({jsonPathJS:e(a),record:t}),E=(a,t,e,r)=>({pluginName:a,commandName:t.command,desc:t.desc??"",text:t.text??"",extractors:G(t,e,r)}),G=(a,t,e)=>a.args.map(r=>((m,s)=>{const o=m.scalars?P(m.scalars,s):void 0,n=m.structs.items.map(u=>P(u,s)),c=m.structArrays.items.map(u=>P(u,s));return{rootCategory:m.rootCategory,rootName:m.rootName,top:o,structs:n,structArrays:c}})(F("args",a.command,r,t),e)),C=(a,t)=>({pluginName:t.pluginName,commandName:t.commandName,values:z(a,t.extractors)}),H=(a,t)=>{const e=l.createClassifiedStructMap(a.schema.structs);return a.schema.commands.map(r=>[`${a.pluginName}:${r.command}`,E(a.pluginName,r,e,t)])},I=/\s*\/\//,L=/\s*[var|let|const]\s+\$plugins\s*=\s*/,x=a=>a.split(`
`).filter(t=>!(e=>I.test(e)||L.test(e))(t)).map(t=>t.endsWith("];")?t.slice(0,-1):t),Q=a=>"name"in a&&typeof a.name=="string",R=a=>"status"in a&&typeof a.status=="boolean",U=a=>"description"in a&&typeof a.description=="string",X=a=>typeof a.parameters=="object"&&a.parameters!==null&&Object.values(a.parameters).every(t=>typeof t=="string");exports.compileCommandExtractorsFromPlugins=(a,t)=>new Map(a.flatMap(e=>H(e,t))),exports.compilePluginCommandExtractor=E,exports.convertPluginsJSToJSON=x,exports.createPluginValuesPathPP=(a,t,e)=>V(a,t,e),exports.createPluginValuesPathPP2=F,exports.createPrimiteveParamPath=k,exports.extractCommandArgsByKey=(a,t,e)=>{const r=e.get(t);if(r)return C(a,r)},exports.extractPluginCommandArgs=C,exports.getPathFromStructArraySchema=T,exports.getPathFromStructParam=O,exports.getPathFromStructSchema=(a,t,e,r=d)=>N(a,t,e,r),exports.makeScalarArrayPath=J,exports.makeScalarValuesPath=M,exports.parsePluginParamObject=a=>{const t=x(a).join(`
`);return JSON.parse(t)},exports.validatePluginJS=a=>!Array.isArray(a)&&typeof a=="object"&&a!==null&&!!(Q(a)&&R(a)&&U(a)&&"parameters"in a)&&X(a);
