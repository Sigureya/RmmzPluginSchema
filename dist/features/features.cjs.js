"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const p=require("../shared/structMap.cjs.js"),F=(a,t)=>{if(a.length!==0)return`${t}[${a.map(r=>`"${r.name}"`).join(",")}]`},J=(a,t)=>a.map(r=>({path:`${t}.${r.name}[*]`,param:r})),A={undefinedStruct:"undefined_struct",cyclicStruct:"cyclic_struct"};function w(a,{path:t,structName:r}){return{category:"struct",objectSchema:p.toObjectPluginParams(a.scalars),name:r,scalarArrays:J(a.scalarArrays,t),scalarsPath:a.scalars.length>0?F(a.scalars,t):void 0}}function S(a,t,r,e){const s={items:[],errs:[],frames:[{schemaName:a,basePath:t,ancestry:[]}]},o=Math.max(1,3*r.size+5),u=Array.from({length:o}).reduce(l=>l.frames.length===0?l:function(m,h,i){if(m.frames.length===0)return m;const c=m.frames[m.frames.length-1],n=m.frames.slice(0,-1);if(c.ancestry.includes(c.schemaName))return{frames:n,items:m.items,errs:[...m.errs,{code:i.cyclicStruct,path:c.basePath}]};const y=h.get(c.schemaName);if(!y)return{frames:n,items:m.items,errs:[...m.errs,{code:i.undefinedStruct,path:c.basePath}]};const C=function(g,x){const v=g.ancestry.concat(g.schemaName),j=g.basePath;return[...x.structs.map(P=>({schemaName:P.attr.struct,basePath:`${j}.${P.name}`,ancestry:v})),...x.structArrays.map(P=>({schemaName:P.attr.struct,basePath:`${j}.${P.name}[*]`,ancestry:v}))].reverse()}(c,y);if(y.scalars.length>0||y.scalarArrays.length>0){const g=w(y,{path:c.basePath,structName:c.schemaName});return n.push(...C),{frames:n,items:[...m.items,g],errs:m.errs}}return n.push(...C),{frames:n,items:m.items,errs:m.errs}}(l,r,e),s);return{items:u.items,errors:u.errs}}const k=(a,t,r,e=A)=>S(a.attr.struct,`${t}.${a.name}`,r,e),V=(a,t,r,e=A)=>S(a.attr.struct,`${t}.${a.name}[*]`,r,e),d=(a,t,r,e)=>p.isStructAttr(r)?_(a,r,e):p.isStructArrayAttr(r)?B(a,r,e):p.isArrayAttr(r)?z(a,t,r):O(a,t,r),z=(a,t,r)=>({rootCategory:a,rootName:t,scalars:{category:a,name:"array",objectSchema:{},scalarsPath:void 0,scalarArrays:[{path:`$.${r.name}[*]`,param:r}]},structs:{items:[],errors:[]},structArrays:{items:[],errors:[]}}),O=(a,t,r)=>({rootCategory:a,rootName:t,scalars:{category:"primitive",name:r.attr.kind,objectSchema:{[r.name]:r.attr},scalarsPath:`$.${r.name}`,scalarArrays:[]},structArrays:{items:[],errors:[]},structs:{items:[],errors:[]}}),_=(a,t,r)=>({rootName:t.name,rootCategory:a,scalars:void 0,structArrays:{items:[],errors:[]},structs:k(t,"$",r)}),B=(a,t,r)=>({structArrays:V(t,"$",r),rootName:t.name,rootCategory:a,scalars:void 0,structs:{items:[],errors:[]}}),K=(a,t,r,e)=>t.filter(s=>typeof s=="number").map(s=>({roootName:a.rootName,rootType:a.rootCategory,value:s,category:"struct",name:r,param:e})),D=(a,t,r,e)=>t.filter(s=>typeof s=="string").map(s=>({roootName:a.rootName,rootType:a.rootCategory,value:s,category:"struct",name:r,param:e})),G=(a,t,r,e,s)=>{if(typeof r=="object"||r===null)return null;const o=e[e.length-1];if(typeof o=="number")return null;const u=s[o];return u?{roootName:a.rootName,rootType:a.rootCategory,category:"struct",name:t,value:r,param:{name:o,attr:u}}:null},q=(a,t)=>t.map(r=>H(a,r)).flat(3),H=(a,t)=>[t.top?f(t,a,t.top):[],t.structs.map(r=>f(t,a,r)),t.structArrays.map(r=>f(t,a,r))],f=(a,t,r)=>{const e=r.bundleName,s=r.scalar?((u,l,m,h,i)=>h.pathSegments(m).map(({value:c,segments:n})=>G(u,l,c,n,i)).filter(c=>c!==null))(a,e,t,r.scalar.jsonPathJS,r.scalar.record):[],o=r.arrays.map(u=>((l,m,h,i)=>{const c=i.jsonPathJS.find(h);if(!Array.isArray(c))return[];const n=i.schema.attr;return p.isStringArrayParam(n)?D(l,c,m,i.schema):p.isNumberArrayParam(n)?K(l,c,m,i.schema):[]})(a,e,t,u));return[s,o].flat(2)},$=(a,t)=>{const r=a.scalars?N(a.scalars,t):void 0,e=a.structs.items.map(o=>N(o,t)),s=a.structArrays.items.map(o=>N(o,t));return{rootCategory:a.rootCategory,rootName:a.rootName,top:r,structs:e,structArrays:s}},N=(a,t)=>a.scalarsPath?{bundleName:a.name,arrays:M(a.scalarArrays,a.name,t),scalar:I(a.scalarsPath,a.objectSchema,t)}:{bundleName:a.name,arrays:M(a.scalarArrays,a.name,t)},M=(a,t,r)=>a.map(e=>({jsonPathJS:r(e.path),schema:e.param,parentType:t})),I=(a,t,r)=>({jsonPathJS:r(a),record:t}),b=(a,t,r,e)=>({pluginName:a,commandName:t.command,desc:t.desc??"",text:t.text??"",extractors:L(t,r,e)}),L=(a,t,r)=>a.args.map(e=>{const s=d("args",a.command,e,t);return $(s,r)}),T=(a,t)=>({pluginName:t.pluginName,commandName:t.commandName,args:q(a,t.extractors)}),E=(a,t)=>{const r=p.createClassifiedStructMap(a.schema.structs);return a.schema.commands.map(e=>[`${a.pluginName}:${e.command}`,b(a.pluginName,e,r,t)])},Q=(a,t,r)=>a.params.map(e=>{const s=d("param",e.name,e,t);return $(s,r)}),R=(a,t,r,e)=>t.map(s=>[`${a}:${s.command}`,b(a,s,r,e)]);exports.compileCommandExtractorsFromPlugins=(a,t)=>new Map(a.flatMap(r=>E(r,t))),exports.compilePluginCommandExtractor=b,exports.compilePluginCommandPairs=E,exports.compilePluginParamExtractor=(a,t,r)=>({pluginName:a.pluginName,extractors:a.schema.params.map(e=>{const s=d("param","plugin",e,t);return $(s,r)})}),exports.createPluginValueExtractor=(a,t,r)=>{const e=p.createClassifiedStructMap(t.structs);return{params:Q(t,e,r),commands:R(a,t.commands,e,r)}},exports.createPluginValuesPath=d,exports.createPrimiteveParamPath=O,exports.createStructParamPath=(a,t,r)=>_(a,t,r),exports.extractCommandArgsByKey=(a,t,r)=>{const e=r.get(t);if(e)return T(a,e)},exports.extractPluginCommandArgs=T,exports.extractPluginParam=(a,t)=>({pluginName:t.pluginName,params:q(a,t.extractors)}),exports.getPathFromStructArraySchema=V,exports.getPathFromStructParam=k,exports.getPathFromStructSchema=(a,t,r,e=A)=>S(a,t,r,e),exports.makeScalarArrayPath=J,exports.makeScalarValuesPath=F;
