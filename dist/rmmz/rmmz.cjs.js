"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const n=require("../shared/parseDeepJSON.cjs.js"),J=(t,e)=>{const a=function(r){return Object.fromEntries(r.map(c=>[c.struct,c.params.filter(n.hasStructAttr)]))}(t);return function(r,c,m){return r.reduce(o=>{if(!o.changed)return o;const l=r.filter(f=>!o.names.has(f)&&c[f].some(i=>o.names.has(i.attr.struct)));return l.length===0?{names:o.names,changed:!1}:{names:new Set([...o.names,...l]),changed:!0}},{names:m,changed:!0}).names}(Object.keys(a),a,new Set(e))},S=(t,e)=>{const a=t.structs.filter(m=>m.params.some(o=>e(o))),r=new Set(a.map(m=>m.struct)),c=J(t.structs,r);return{structs:tt(t.structs,c,e),commands:V(t.commands,c,e),params:I(t.params,c,e)}},I=(t,e,a)=>t.filter(r=>n.hasStructAttr(r)?e.has(r.attr.struct):a(r)),tt=(t,e,a)=>t.map(r=>({struct:r.struct,params:I(r.params,e,a)})).filter(r=>r.params.length>0),V=(t,e,a)=>t.map(r=>({...r.desc?{desc:r.desc}:{},...r.text?{text:r.text}:{},command:r.command,args:I(r.args,e,a)})).filter(r=>r.args.length>0),et={variable:1,switch:2,actor:0,item:0,weapon:0,armor:0,skill:0,class:0,state:0,troop:0,enemy:0,common_event:0},at=["data","system","system"],x=t=>{const e=et[t];return e===void 0?{author:"rmmz",module:"unknown",kind:t}:{author:"rmmz",module:at[e],kind:[t,"variable","switch"][e]}},U=(t,e,a)=>{const r=e.get(t);return r?r.filter(c=>((m,o)=>!(!n.isStructParam(m)&&!n.isStructArrayParam(m)||!m.struct||o.has(m.struct)))(c,a)).flatMap(c=>{const m=c.struct;return a.add(m),[m,...U(m,e,a)]}):[]},P=t=>typeof t=="object"&&t!==null&&!Array.isArray(t),j=t=>Array.isArray(t)?rt(t):P(t)?O(t):{},O=t=>P(t)?Object.fromEntries(Object.entries(t).map(([e,a])=>{if(Array.isArray(a)){const r=a.map(c=>P(c)?JSON.stringify(O(c)):String(c));return[e,JSON.stringify(r)]}return P(a)?[e,JSON.stringify(O(a))]:[e,String(a)]})):{},rt=t=>t.map(e=>typeof e=="object"&&e!==null?JSON.stringify(O(e)):String(e)),z=(t,e)=>{const a=Object.entries(e).filter(([r])=>r in t).map(([r,c])=>[r,c(t[r])]);return Object.fromEntries(a)},A=(t,e,a,r)=>({default:e,...z(a,r),kind:t}),y=(t,e,a)=>({default:[],...z(e,a),kind:t}),nt=(t,e)=>{const a=t.map(r=>r.locale===void 0?r.struct:r.locale===e?`${r.struct}!`:"");return new Set(a)},K="BODY",W="STRUCT",g="NONE",st=(t,e)=>{const a=e.trim(),r=a.match(/^\/\*~struct~([A-Za-z0-9_]*)(?::([A-Za-z0-9_-]+))?/);return r?ct(t,r):/^\/\*:/.test(a)?ot(t,a):a==="*/"?t.lines.length>0?L(t):t:{...t,lines:t.lines.concat([a])}},ct=(t,e)=>{const a=t.lines.length>0?L(t):t,r=e[1]||void 0;return{...a,structName:r,blockType:r?W:"INVALID",locale:e[2],lines:[]}},mt=t=>{if(t){const e=t.match(/^\/\*:(\w+)/);if(e)return e[1]}},ot=(t,e)=>({...t.lines.length>0?L(t):t,locale:mt(e),blockType:K,lines:[]}),L=t=>{if(t.blockType===K){const e=t.locale?{locale:t.locale,lines:[...t.lines]}:{lines:[...t.lines]};return{...t,bodies:t.bodies.concat([e]),lines:[],blockType:g,locale:void 0}}return t.structName&&t.blockType===W?{...t,structs:t.structs.concat([{struct:t.structName,locale:t.locale,lines:[...t.lines]}]),blockType:g,structName:void 0,locale:void 0,lines:[]}:{...t,blockType:g,structName:void 0,locale:void 0,lines:[]}},it=t=>t.currentOption?{items:t.items.concat({option:t.currentOption,value:t.currentOption})}:t,$="help",N="kind",h="text",D="struct",M=(t,e)=>{if(N in t.attr){const a=ut[t.attr.kind];if(a)return a(t,e)}return{name:t.name,attr:A("any","",t.attr,b)}},s=t=>t,Z=t=>t.replace("[","").replace("]","").split(",").map(e=>parseFloat(e.replaceAll('"',"").trim())).filter(e=>!isNaN(e)),b={default:s,text:s,desc:s,parent:s},R=(t,e)=>({name:t.name,attr:A(e,"",t.attr,b)}),k=(t,e,a)=>{const r={default:c=>e.parseStringArray(c).value,text:s,desc:s,parent:s};return{name:t.name,attr:y(a,t.attr,r)}},p=(t,e)=>{const a={default:r=>Z(r),text:s,desc:s,parent:s};return{name:t.name,attr:y(e,t.attr,a)}},d=(t,e)=>{const a={default:r=>parseInt(r,10),text:s,desc:s,parent:s};return{name:t.name,attr:A(e,0,t.attr,a)}},w=t=>t.length>0?{errors:t}:{},ut={actor:t=>d(t,"actor"),"actor[]":t=>p(t,"actor[]"),class:t=>d(t,"class"),"class[]":t=>p(t,"class[]"),skill:t=>d(t,"skill"),"skill[]":t=>p(t,"skill[]"),item:t=>d(t,"item"),"item[]":t=>p(t,"item[]"),weapon:t=>d(t,"weapon"),"weapon[]":t=>p(t,"weapon[]"),armor:t=>d(t,"armor"),"armor[]":t=>p(t,"armor[]"),state:t=>d(t,"state"),"state[]":t=>p(t,"state[]"),enemy:t=>d(t,"enemy"),"enemy[]":t=>p(t,"enemy[]"),common_event:t=>d(t,"common_event"),"common_event[]":t=>p(t,"common_event[]"),switch:t=>d(t,"switch"),"switch[]":t=>p(t,"switch[]"),variable:t=>d(t,"variable"),"variable[]":t=>p(t,"variable[]"),troop:t=>d(t,"troop"),"troop[]":t=>p(t,"troop[]"),file:t=>{const e={default:s,text:s,desc:s,parent:s,dir:s};return{name:t.name,attr:{dir:"",...A("file","",t.attr,e)}}},"file[]":(t,e)=>{const a={default:r=>e.parseStringArray(r).value,text:s,desc:s,parent:s,dir:s};return{name:t.name,attr:{dir:"",...y("file[]",t.attr,a)}}},combo:t=>{var a;const e=((a=t.options)==null?void 0:a.map(r=>r.option))??[];return{name:t.name,attr:{...A("combo","",t.attr,b),options:e}}},select:t=>{var a;const e=((a=t.options)==null?void 0:a.map(r=>({option:r.option,value:r.value})))??[];return{name:t.name,attr:{...A("select","",t.attr,b),options:e}}},struct:(t,e)=>{const{errors:a,value:r}=e.parseObject(t.attr.default||"{}"),c={text:s,desc:s,parent:s},m=a.length===0?r:{};return{name:t.name,attr:{struct:t.attr.struct||"",...A("struct",m,t.attr,c),...w(a)}}},"struct[]":(t,e)=>{const{errors:a,value:r}=e.parseObjectArray(t.attr.default||"[]"),c={text:s,desc:s,parent:s},m=a.length===0?r:[];return{name:t.name,attr:{struct:t.attr.struct||"",...A("struct[]",m,t.attr,c),...w(a)}}},boolean:t=>{const e={default:a=>a==="true",text:s,desc:s,on:s,off:s,parent:s};return{name:t.name,attr:A("boolean",!0,t.attr,e)}},number:t=>{const e={default:a=>parseFloat(a),text:s,desc:s,decimals:a=>parseInt(a,10),min:a=>parseFloat(a),max:a=>parseFloat(a),parent:s};return{name:t.name,attr:A("number",0,t.attr,e)}},"number[]":t=>{const e={default:a=>Z(a),text:s,desc:s,decimals:a=>parseInt(a,10),min:a=>parseFloat(a),max:a=>parseFloat(a),parent:s};return{name:t.name,attr:y("number[]",t.attr,e)}},string:t=>R(t,"string"),"string[]":(t,e)=>k(t,e,"string[]"),multiline_string:t=>R(t,"multiline_string"),"multiline_string[]":(t,e)=>k(t,e,"multiline_string[]")},H=t=>!Array.isArray(t)&&typeof t=="object"&&t!==null&&!!(lt(t)&&pt(t)&&dt(t)&&"parameters"in t)&&ft(t),lt=t=>"name"in t&&typeof t.name=="string",pt=t=>"status"in t&&typeof t.status=="boolean",dt=t=>"description"in t&&typeof t.description=="string",ft=t=>typeof t.parameters=="object"&&t.parameters!==null&&Object.values(t.parameters).every(e=>typeof e=="string"),At=/\s*\/\//,St=/\s*[var|let|const]\s+[^\s]+\s*=/,Pt=/^\s{0,3}[\[|\]\;]/,Y=t=>t.split(`
`).filter(e=>!(a=>At.test(a)||Pt.test(a)||St.test(a))(e)),B=t=>{const e=`[${Y(t).join("")}]`,a=JSON.parse(e);if(!Array.isArray(a))throw new Error("Parsed value is not an array");if(a.every(H))return a;throw new Error("Parsed value is not PluginParamsObject array")},gt=(t,e)=>{const a=e.get(t.name);if(!a)return t.parameters;const r=Object.entries(t.parameters).filter(([c])=>!a.has(c));return Object.fromEntries(r)},Et=t=>new Map(t.map(e=>[e.pluginName,new Set(e.params)])),C=()=>({parseStringArray:t=>({value:Ot(t),errors:[]}),parseObjectArray:()=>({value:[],errors:[]}),parseObject:t=>({value:n.parseDeepJSON(t),errors:[]})}),Ot=t=>{try{const e=JSON.parse(t);if(Array.isArray(e)&&e.every(a=>typeof a=="string"))return e}catch{}return[]},v=t=>({...typeof t.desc=="string"?{desc:t.desc}:{},...typeof t.text=="string"?{text:t.text}:{}}),E=t=>{const e=yt(t),a=ht(e);return bt(a)},yt=t=>{if(t.currentParam&&t.currentOption){const e=t.currentParam.attr.kind;if(e==="select"||e==="combo")return{...t,currentParam:{...t.currentParam,options:it(t.currentOption).items}}}return t},bt=t=>t.currentParam?{...t,params:[...t.params,t.currentParam],currentCommand:null,currentOption:null,currentParam:null,currentContext:null}:t,ht=t=>{if(!t.currentCommand)return t;const e=t.currentParam?[...t.currentCommand.args,t.currentParam]:t.currentCommand.args,a={...v(t.currentCommand),command:t.currentCommand.command,args:e};return{...t,commands:[...t.commands,a],currentCommand:null,currentParam:null,currentContext:null,currentOption:null}},G=(t,e="en")=>{const a=(o=>{const l=o.split(`
`),f={structs:[],bodies:[],structName:void 0,locale:void 0,lines:[],blockType:g},i=l.reduce((Q,X)=>st(Q,X),f);return{structs:i.structs,bodies:i.bodies}})(t),r=((o,l)=>{const f=nt(o,l);return o.filter(i=>i.locale===void 0&&f.has(i.struct)?!f.has(`${i.struct}!`):i.locale===l&&f.has(`${i.struct}!`))})(a.structs,e).map(o=>_t(o)),c=((o,l)=>o.reduce((f,i)=>i.locale===l||i.locale===void 0&&f===void 0?i:f,void 0))(a.bodies,e);if(!c)return{params:[],commands:[],meta:{},helpLines:[],structs:r};const m=q(c);return{params:m.params,commands:m.commands,meta:m.meta,helpLines:m.helpLines,structs:r,dependencies:m.dependencies}},_t=t=>{const e=q(t);return{name:t.struct,params:e.params}},q=t=>{const e=t.lines.reduce((a,r)=>vt(a,r),Nt());return E(e)},Nt=()=>({helpLines:[],params:[],commands:[],currentParam:null,currentCommand:null,currentContext:null,currentOption:null,dependencies:{base:[],orderBefore:[],orderAfter:[]},meta:{}}),vt=(t,e,a=It)=>{const r=e.trimEnd().replace(/^[\*\s]*/,"");if(!r.startsWith("@"))return t.currentContext===$?{...t,helpLines:t.helpLines.concat(r)}:t;const c=r.match(/^@(\S+)\s*(.*)$/);if(!c)return t;const[,m,o]=c,l=a[m];return l?l(t,o.trim()):t},u=(t,e,a)=>t.currentParam&&!(e in t.currentParam.attr)?{...t,currentParam:{...t.currentParam,attr:{...t.currentParam.attr,[e]:a}}}:t,_=(t,e,a)=>({...t,meta:{[e]:a,...t.meta}}),It={param:(t,e)=>{const a=E(t);return a.params.some(r=>r.name===e)?a:{...a,currentContext:"param",currentParam:{name:e,attr:{}}}},text:(t,e)=>t.currentParam?u(t,h,e):t.currentCommand&&!(h in t.currentCommand)?{...t,currentCommand:{...v(t.currentCommand),command:t.currentCommand.command,args:t.currentCommand.args,[h]:e}}:t,desc:(t,e)=>t.currentParam?u(t,"desc",e):t.currentCommand?{...t,currentCommand:{...t.currentCommand,desc:e}}:t,command:(t,e)=>{const a=E(t);return a.commands.some(r=>r.command===e)?a:{...a,currentCommand:{command:e,args:[]},currentParam:null}},arg:(t,e)=>{if(!t.currentCommand)return t;if(!t.currentParam)return{...t,currentParam:{name:e,attr:{}}};const a={...v(t.currentCommand),command:t.currentCommand.command,args:t.currentCommand.args.concat(t.currentParam)};return{...t,commands:t.commands,currentCommand:a,currentContext:"arg",currentParam:{name:e,attr:{}}}},help:t=>({...E(t),currentContext:$}),option:(t,e)=>{if(!t.currentParam)return t;const a=((r,c)=>r.currentOption?{items:r.items.concat({option:r.currentOption,value:r.currentOption}),currentOption:c}:{items:r.items,currentOption:c})(t.currentOption??{items:[]},e);return{...t,currentOption:a}},value:(t,e)=>{if(!t.currentOption)return t;const a=((r,c)=>r.currentOption?{items:r.items.concat({option:r.currentOption,value:c})}:{items:r.items})(t.currentOption,e);return{...t,currentOption:a}},type:(t,e)=>{if((a=>a.endsWith(">")&&a.startsWith("struct<"))(e)){const a=e.slice(7,-1),r=u(t,D,a);return u(r,N,D)}return t.currentParam?u(t,N,e):t},parent:(t,e)=>u(t,"parent",e),default:(t,e)=>u(t,"default",e),on:(t,e)=>u(t,"on",e),off:(t,e)=>u(t,"off",e),min:(t,e)=>u(t,"min",e),max:(t,e)=>u(t,"max",e),decimals:(t,e)=>u(t,"decimals",e),dir:(t,e)=>u(t,"dir",e),base:(t,e)=>{return{...t,dependencies:(a=t.dependencies,r=e,{orderAfter:a.orderAfter,orderBefore:a.orderBefore,base:a.base.concat(r)})};var a,r},orderAfter:(t,e)=>{return{...t,dependencies:(a=t.dependencies,r=e,{base:a.base,orderBefore:a.orderBefore,orderAfter:a.orderAfter.concat(r)})};var a,r},orderBefore:(t,e)=>{return{...t,dependencies:(a=t.dependencies,r=e,{base:a.base,orderAfter:a.orderAfter,orderBefore:a.orderBefore.concat(r)})};var a,r},author:(t,e)=>_(t,"author",e),plugindesc:(t,e)=>_(t,"plugindesc",e),url:(t,e)=>_(t,"url",e)},Lt=t=>{const e=C();return{target:"MZ",meta:t.meta,commands:Mt(t.commands,e),params:F(t.params,e),structs:Ct(t.structs,e)}},F=(t,e)=>Object.fromEntries(t.map(a=>{const r=M(a,e);return[a.name,r.attr]})),Mt=(t,e)=>Object.fromEntries(t.map(a=>[a.command,{desc:a.desc,text:a.text,args:F(a.args,e)}])),Ct=(t,e)=>Object.fromEntries(t.map(a=>[a.name,{params:F(a.params,e)}])),Ft=(t,e=C())=>({params:T(t.params,e),commands:Tt(t.commands,e),structs:xt(t.structs,e)}),T=(t,e)=>t.map(a=>M(a,e)),Tt=(t,e)=>t.map(a=>({command:a.command,desc:a.desc,text:a.text,args:T(a.args,e)})),xt=(t,e)=>t.map(a=>({struct:a.name,params:T(a.params,e)}));exports.classifyFileParams=n.classifyFileParams,exports.classifyPluginParams=n.classifyPluginParams,exports.classifyTextParams=n.classifyTextParams,exports.convertPluginCommandSchema=n.convertPluginCommandSchema,exports.convertStructSchema=n.convertStructSchema,exports.createClassifiedStructMap=n.createClassifiedStructMap,exports.createStructMap=n.createStructMap,exports.hasNumberValueParam=n.hasNumberValueParam,exports.hasScalarAttr=n.hasScalarAttr,exports.hasStructAttr=n.hasStructAttr,exports.hasTextAttr=n.hasTextAttr,exports.isArrayAttr=n.isArrayAttr,exports.isArrayParam=n.isArrayParam,exports.isArrayParamEx=n.isArrayParamEx,exports.isFileAttr=n.isFileAttr,exports.isNumberArrayParam=n.isNumberArrayParam,exports.isNumberAttr=n.isNumberAttr,exports.isNumberValueParam=n.isNumberValueParam,exports.isNumberValueParamEx=n.isNumberValueParamEx,exports.isScalarParam=n.isScalarParam,exports.isStringArrayParam=n.isStringArrayParam,exports.isStringValueParam=n.isStringValueParam,exports.isStructArrayAttr=n.isStructArrayAttr,exports.isStructArrayParam=n.isStructArrayParam,exports.isStructAttr=n.isStructAttr,exports.isStructParam=n.isStructParam,exports.isVariableAttr=n.isVariableAttr,exports.paramHasText=n.paramHasText,exports.parseDeepJSON=n.parseDeepJSON,exports.parseDeepRecord=n.parseDeepRecord,exports.toArrayPluginParam=n.toArrayPluginParam,exports.toObjectPluginParams=n.toObjectPluginParams,exports.toObjectPluginParamsOld=n.toObjectPluginParamsOld,exports.FILENAME_ACTORS="Actors.json",exports.FILENAME_ANIMATIONS="Animations.json",exports.FILENAME_ARMORS="Armors.json",exports.FILENAME_CLASSES="Classes.json",exports.FILENAME_COMMON_EVENTS="CommonEvents.json",exports.FILENAME_ENEMIES="Enemies.json",exports.FILENAME_ITEMS="Items.json",exports.FILENAME_MAP_INFOS="MapInfos.json",exports.FILENAME_SKILLS="Skills.json",exports.FILENAME_STATES="States.json",exports.FILENAME_SYSTEM="System.json",exports.FILENAME_TILESET="Tilesets.json",exports.FILENAME_TROOPS="Troops.json",exports.FILENAME_WEAPONS="Weapons.json",exports.FOLDER_AUDIO="audio",exports.FOLDER_AUDIO_BGM="bgm",exports.FOLDER_AUDIO_BGS="bgs",exports.FOLDER_AUDIO_ME="me",exports.FOLDER_AUDIO_SE="se",exports.FOLDER_DATA="data",exports.FOLDER_IMG="img",exports.FOLDER_IMG_BATTLEBACK1="battlebacks1",exports.FOLDER_IMG_BATTLEBACK2="battlebacks2",exports.FOLDER_IMG_CHACTERS="characters",exports.FOLDER_IMG_ENEMIES="enemies",exports.FOLDER_IMG_FACES="faces",exports.FOLDER_IMG_PARALLACES="parallaxes",exports.FOLDER_IMG_PICTURES="pictures",exports.FOLDER_IMG_SV_ACTORS="sv_actors",exports.FOLDER_IMG_SV_ENEMIES="sv_enemies",exports.FOLDER_IMG_SYSTEM="system",exports.FOLDER_IMG_TILESETS="tilesets",exports.FOLDER_IMG_TITLES1="titles1",exports.FOLDER_IMG_TITLES2="titles2",exports.FOLDER_JS="js",exports.collectDependentStructNames=J,exports.compileAttributes=(t,e)=>{const{attr:a}=M(t,e);return a},exports.convertPluginsJSToJSON=Y,exports.filterPluginParamByText=t=>S(t,n.hasTextAttr),exports.filterPluginSchemaByFileParam=t=>S(t,n.isFileAttr),exports.filterPluginSchemaByNumberParam=t=>S(t,n.isNumberAttr),exports.filterPluginSchemaByParam=S,exports.filterPluginSchemaByVariableParam=t=>S(t,n.isVariableAttr),exports.isRmmzDataKind=t=>{const e=x(t.kind);return e.author===t.author&&e.module===t.module&&e.kind===t.kind},exports.lookupKind=x,exports.omitPluginParam=(t,e)=>{const a=Et(e);return t.map(r=>({description:r.description,name:r.name,status:r.status,parameters:gt(r,a)}))},exports.parsePluginParamObject=t=>B(t).map(e=>({description:e.description,name:e.name,status:e.status,parameters:n.parseDeepRecord(e.parameters)})),exports.parsePluginParamRecord=B,exports.pluginSourceToArraySchema=(t,e=C())=>{const a=G(t.source,t.locale);return{meta:a.meta,pluginName:t.pluginName,target:"MZ",schema:Ft(a,e)}},exports.pluginSourceToJSON=t=>(e=>Lt(G(e)))(t),exports.rebuildCommands=V,exports.stringifyDeepJSON=t=>JSON.stringify(j(t)),exports.stringifyDeepRecord=t=>j(t),exports.structDependencies=(t,e)=>U(t,e,new Set),exports.validatePluginJS=H;
