"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const s=require("../shared/structMap.cjs.js"),U=(r,e)=>{const t=function(a){return Object.fromEntries(a.map(n=>[n.struct,n.params.filter(s.hasStructAttr)]))}(r);return function(a,n,m){return a.reduce(o=>{if(!o.changed)return o;const A=a.filter(f=>!o.names.has(f)&&n[f].some(i=>o.names.has(i.attr.struct)));return A.length===0?{names:o.names,changed:!1}:{names:new Set([...o.names,...A]),changed:!0}},{names:m,changed:!0}).names}(Object.keys(t),t,new Set(e))},S=(r,e)=>{const t=r.structs.filter(m=>m.params.some(o=>e(o))),a=new Set(t.map(m=>m.struct)),n=U(r.structs,a);return{structs:ar(r.structs,n,e),commands:z(r.commands,n,e),params:T(r.params,n,e)}},T=(r,e,t)=>r.filter(a=>s.hasStructAttr(a)?e.has(a.attr.struct):t(a)),ar=(r,e,t)=>r.map(a=>({struct:a.struct,params:T(a.params,e,t)})).filter(a=>a.params.length>0),z=(r,e,t)=>r.map(a=>({...a.desc?{desc:a.desc}:{},...a.text?{text:a.text}:{},command:a.command,args:T(a.args,e,t)})).filter(a=>a.args.length>0),nr={variable:1,switch:2,actor:0,item:0,weapon:0,armor:0,skill:0,class:0,state:0,troop:0,enemy:0,common_event:0},sr=["data","system","system"],R=r=>{const e=nr[r];return e===void 0?{author:"rmmz",module:"unknown",kind:r}:{author:"rmmz",module:sr[e],kind:[r,"variable","switch"][e]}},K=(r,e,t)=>{const a=e.get(r);return a?a.filter(n=>((m,o)=>!(!s.isStructParam(m)&&!s.isStructArrayParam(m)||!m.struct||o.has(m.struct)))(n,t)).flatMap(n=>{const m=n.struct;return t.add(m),[m,...K(m,e,t)]}):[]},P=r=>{const e=JSON.parse(r);return Array.isArray(e)?e.map(g):typeof e=="object"&&e!==null?W(e):e},k=r=>W(r),W=r=>Object.fromEntries(Object.entries(r).map(([e,t])=>[e,g(t)])),g=r=>{if(typeof r!="string")return r;try{const e=JSON.parse(r);return Array.isArray(e)?e.map(g):typeof e=="object"&&e!==null?Object.fromEntries(Object.entries(e).map(([t,a])=>[t,g(a)])):e}catch{return r}},E=r=>typeof r=="object"&&r!==null&&!Array.isArray(r),cr=r=>Array.isArray(r)?mr(r):E(r)?_(r):{},_=r=>E(r)?Object.fromEntries(Object.entries(r).map(([e,t])=>{if(Array.isArray(t)){const a=t.map(n=>E(n)?JSON.stringify(_(n)):String(n));return[e,JSON.stringify(a)]}return E(t)?[e,JSON.stringify(_(t))]:[e,String(t)]})):{},mr=r=>r.map(e=>typeof e=="object"&&e!==null?JSON.stringify(_(e)):String(e)),Z=(r,e)=>Object.entries(e).reduce((t,[a,n])=>{if(a in r){const m=r[a];if(typeof m=="string")return{...t,[a]:n(m)}}return t},{}),p=(r,e,t,a)=>({default:e,...Z(t,a),kind:r}),h=(r,e,t)=>({default:[],...Z(e,t),kind:r}),H="BODY",Y="STRUCT",b="NONE",or=(r,e)=>{const t=r.lines.length>0?x(r):r,a=e[1]||void 0;return{...t,structName:a,blockType:a?Y:"INVALID",locale:e[2],lines:[]}},ir=r=>({...r.lines.length>0?x(r):r,blockType:H,structName:void 0,locale:void 0,lines:[]}),x=r=>r.blockType===H?{...r,bodies:r.bodies.concat([{lines:[...r.lines]}]),lines:[],blockType:b}:r.structName&&r.blockType===Y?{...r,structs:r.structs.concat([{struct:r.structName,locale:r.locale,lines:[...r.lines]}]),blockType:b,structName:void 0,locale:void 0,lines:[]}:{...r,blockType:b,structName:void 0,lines:[]},ur=r=>r.currentOption?{items:r.items.concat({option:r.currentOption,value:r.currentOption})}:r,$="help",M="kind",I="text",w="struct",C=r=>{if(M in r.attr){const e=lr[r.attr.kind];if(e)return e(r)}return p("any","",r.attr,N)},c=r=>r,q=r=>r.replace("[","").replace("]","").split(",").map(e=>parseFloat(e.replaceAll('"',"").trim())).filter(e=>!isNaN(e)),N={default:c,text:c,desc:c,parent:c},B=r=>p("string","",r.attr,N),G=r=>{const e={default:t=>P(t),text:c,desc:c,parent:c};return h("string[]",r.attr,e)},u=(r,e)=>{const t={default:q,text:c,desc:c,parent:c};return h(e,r.attr,t)},l=(r,e)=>{const t={default:a=>parseInt(a,10),text:c,desc:c,parent:c};return p(e,0,r.attr,t)},lr={number:r=>(e=>{const t={default:a=>parseFloat(a),text:c,desc:c,decimals:a=>parseInt(a,10),min:a=>parseFloat(a),max:a=>parseFloat(a),parent:c};return p("number",0,e.attr,t)})(r),"number[]":r=>{const e={default:q,text:c,desc:c,decimals:t=>parseInt(t,10),min:t=>parseFloat(t),max:t=>parseFloat(t),parent:c};return h("number[]",r.attr,e)},string:B,"string[]":G,multiline_string:B,"multiline_string[]":G,combo:r=>{var t;const e=((t=r.options)==null?void 0:t.map(a=>a.option))??[];return{...p("combo","",r.attr,N),options:e}},select:r=>{var t;const e=((t=r.options)==null?void 0:t.map(a=>({option:a.option,value:a.value})))??[];return{...p("select","",r.attr,N),options:e}},actor:r=>l(r,"actor"),"actor[]":r=>u(r,"actor[]"),class:r=>l(r,"class"),"class[]":r=>u(r,"class[]"),skill:r=>l(r,"skill"),"skill[]":r=>u(r,"skill[]"),item:r=>l(r,"item"),"item[]":r=>u(r,"item[]"),weapon:r=>l(r,"weapon"),"weapon[]":r=>u(r,"weapon[]"),armor:r=>l(r,"armor"),"armor[]":r=>u(r,"armor[]"),state:r=>l(r,"state"),"state[]":r=>u(r,"state[]"),enemy:r=>l(r,"enemy"),"enemy[]":r=>u(r,"enemy[]"),common_event:r=>l(r,"common_event"),"common_event[]":r=>u(r,"common_event[]"),switch:r=>l(r,"switch"),"switch[]":r=>u(r,"switch[]"),variable:r=>l(r,"variable"),"variable[]":r=>u(r,"variable[]"),troop:r=>l(r,"troop"),"troop[]":r=>u(r,"troop[]"),boolean:r=>{const e={default:t=>t==="true",text:c,desc:c,on:c,off:c,parent:c};return p("boolean",!0,r.attr,e)},file:r=>{const e={default:c,text:c,desc:c,parent:c,dir:c};return{dir:"",...p("file","",r.attr,e)}},"file[]":r=>{const e={default:t=>P(t),text:c,desc:c,parent:c,dir:c};return{dir:"",...h("file[]",r.attr,e)}},struct:r=>{const e=(a=>{if(!a.attr.default)return{};const n=P(a.attr.default);return Array.isArray(n)?{}:typeof n=="object"&&n!==null?n:{}})(r),t={text:c,desc:c,parent:c};return{struct:r.attr.struct||"",...p("struct",e,r.attr,t)}},"struct[]":r=>{const e=(a=>{if(!a.attr.default)return[];const n=P(a.attr.default);return Array.isArray(n)&&n.every(m=>typeof m=="object"&&m!==null)?n:[]})(r),t={text:c,desc:c,parent:c};return{struct:r.attr.struct||"",...p("struct[]",e,r.attr,t),default:e}}},Q=r=>!Array.isArray(r)&&typeof r=="object"&&r!==null&&!!(dr(r)&&pr(r)&&fr(r)&&"parameters"in r)&&Ar(r),dr=r=>"name"in r&&typeof r.name=="string",pr=r=>"status"in r&&typeof r.status=="boolean",fr=r=>"description"in r&&typeof r.description=="string",Ar=r=>typeof r.parameters=="object"&&r.parameters!==null&&Object.values(r.parameters).every(e=>typeof e=="string"),Sr=/\s*\/\//,Pr=/\s*[var|let|const]\s+[^\s]+\s*=/,yr=/^\s{0,3}[\[|\]\;]/,X=r=>r.split(`
`).filter(e=>!(t=>Sr.test(t)||yr.test(t)||Pr.test(t))(e)),V=r=>{const e=`[${X(r).join("")}]`,t=JSON.parse(e);if(!Array.isArray(t))throw new Error("Parsed value is not an array");if(t.every(Q))return t;throw new Error("Parsed value is not PluginParamsObject array")},F=r=>({...typeof r.desc=="string"?{desc:r.desc}:{},...typeof r.text=="string"?{text:r.text}:{}}),O=r=>{const e=Er(r),t=Or(e);return br(t)},Er=r=>{if(r.currentParam&&r.currentOption){const e=r.currentParam.attr.kind;if(e==="select"||e==="combo")return{...r,currentParam:{...r.currentParam,options:ur(r.currentOption).items}}}return r},br=r=>r.currentParam?{...r,params:[...r.params,r.currentParam],currentParam:null,currentContext:null}:r,Or=r=>{if(!r.currentCommand)return r;const e=r.currentParam?[...r.currentCommand.args,r.currentParam]:r.currentCommand.args,t={...F(r.currentCommand),command:r.currentCommand.command,args:e};return{...r,commands:[...r.commands,t],currentCommand:null,currentParam:null,currentContext:null,currentOption:null}},J=r=>{const e=(m=>{const o=m.split(`
`),A={structs:[],bodies:[],structName:void 0,locale:void 0,lines:[],blockType:b},f=o.reduce((i,tr)=>{const y=tr.trim(),D=y.match(/^\/\*~struct~([A-Za-z0-9_]+)(?::([A-Za-z0-9_-]+))?/);return D?or(i,D):y==="/*:"?ir(i):y==="*/"?i.lines.length>0?x(i):i:{...i,lines:i.lines.concat([y])}},A);return{structs:f.structs,bodies:f.bodies}})(r),t=e.structs.map(m=>gr(m)),a=_r(e);if(!a)return{params:[],commands:[],meta:{},helpLines:[],structs:t};const n=rr(a,er);return{params:n.params,commands:n.commands,meta:n.meta,helpLines:n.helpLines,structs:t}},gr=r=>{const e=rr(r,er);return{name:r.struct,params:e.params}},_r=r=>{if(r.bodies.length!==0)return r.bodies[0]},rr=(r,e)=>{const t=r.lines.reduce((a,n)=>{const m=n.trimEnd().replace(/^[\*\s]*/,"");if(!m.startsWith("@"))return a.currentContext===$?{...a,helpLines:a.helpLines.concat(m)}:a;const o=m.match(/^@(\S+)\s*(.*)$/);if(!o)return a;const[,A,f]=o,i=e[A];return i?i(a,f.trim()):a},hr());return O(t)},hr=()=>({helpLines:[],params:[],commands:[],currentParam:null,currentCommand:null,currentContext:null,currentOption:null,dependencies:{base:[],orderBefore:[],orderAfter:[]},meta:{}}),d=(r,e,t)=>r.currentParam&&!(e in r.currentParam.attr)?{...r,currentParam:{...r.currentParam,attr:{...r.currentParam.attr,[e]:t}}}:r,L=(r,e,t)=>({...r,meta:{[e]:t,...r.meta}}),er={param:(r,e)=>{const t=O(r);return t.params.some(a=>a.name===e)?t:{...t,currentContext:"param",currentParam:{name:e,attr:{}}}},text:(r,e)=>r.currentParam?d(r,I,e):r.currentCommand&&!(I in r.currentCommand)?{...r,currentCommand:{...F(r.currentCommand),command:r.currentCommand.command,args:r.currentCommand.args,[I]:e}}:r,desc:(r,e)=>r.currentParam?d(r,"desc",e):r.currentCommand?{...r,currentCommand:{...r.currentCommand,desc:e}}:r,command:(r,e)=>{const t=O(r);return t.commands.some(a=>a.command===e)?t:{...t,currentCommand:{command:e,args:[]},currentParam:null}},arg:(r,e)=>{if(!r.currentCommand)return r;if(!r.currentParam)return{...r,currentParam:{name:e,attr:{}}};const t={...F(r.currentCommand),command:r.currentCommand.command,args:r.currentCommand.args.concat(r.currentParam)};return{...r,commands:r.commands,currentCommand:t,currentContext:"arg",currentParam:{name:e,attr:{}}}},help:r=>({...O(r),currentContext:$}),option:(r,e)=>{if(!r.currentParam)return r;const t=((a,n)=>a.currentOption?{items:a.items.concat({option:a.currentOption,value:a.currentOption}),currentOption:n}:{items:a.items,currentOption:n})(r.currentOption??{items:[]},e);return{...r,currentOption:t}},value:(r,e)=>{if(!r.currentOption)return r;const t=((a,n)=>a.currentOption?{items:a.items.concat({option:a.currentOption,value:n})}:{items:a.items})(r.currentOption,e);return{...r,currentOption:t}},type:(r,e)=>{if((t=>t.endsWith(">")&&t.startsWith("struct<"))(e)){const t=e.slice(7,-1),a=d(r,w,t);return d(a,M,w)}return r.currentParam?d(r,M,e):r},default:(r,e)=>d(r,"default",e),on:(r,e)=>d(r,"on",e),off:(r,e)=>d(r,"off",e),min:(r,e)=>d(r,"min",e),max:(r,e)=>d(r,"max",e),base:(r,e)=>{return{...r,dependencies:(t=r.dependencies,a=e,{orderAfter:t.orderAfter,orderBefore:t.orderBefore,base:t.base.concat(a)})};var t,a},orderAfter:(r,e)=>{return{...r,dependencies:(t=r.dependencies,a=e,{base:t.base,orderBefore:t.orderBefore,orderAfter:t.orderAfter.concat(a)})};var t,a},orderBefore:(r,e)=>{return{...r,dependencies:(t=r.dependencies,a=e,{base:t.base,orderAfter:t.orderAfter,orderBefore:t.orderBefore.concat(a)})};var t,a},author:(r,e)=>L(r,"author",e),plugindesc:(r,e)=>L(r,"plugindesc",e),url:(r,e)=>L(r,"url",e)},Nr=r=>({target:"MZ",meta:r.meta,commands:Ir(r.commands),params:v(r.params),structs:Lr(r.structs)}),v=r=>Object.fromEntries(r.map(e=>[e.name,C(e)])),Ir=r=>Object.fromEntries(r.map(e=>[e.command,{desc:e.desc,text:e.text,args:v(e.args)}])),Lr=r=>Object.fromEntries(r.map(e=>[e.name,{params:v(e.params)}])),j=r=>r.map(e=>({name:e.name,attr:C(e)})),Mr=r=>r.map(e=>({command:e.command,desc:e.desc,text:e.text,args:j(e.args)})),Fr=r=>r.map(e=>({struct:e.name,params:j(e.params)}));exports.classifyFileParams=s.classifyFileParams,exports.classifyPluginParams=s.classifyPluginParams,exports.classifyTextParams=s.classifyTextParams,exports.convertPluginCommandSchema=s.convertPluginCommandSchema,exports.convertStructSchema=s.convertStructSchema,exports.createClassifiedStructMap=s.createClassifiedStructMap,exports.createStructMap=s.createStructMap,exports.hasNumberValueParam=s.hasNumberValueParam,exports.hasScalarAttr=s.hasScalarAttr,exports.hasStructAttr=s.hasStructAttr,exports.hasTextAttr=s.hasTextAttr,exports.isArrayAttr=s.isArrayAttr,exports.isArrayParam=s.isArrayParam,exports.isArrayParamEx=s.isArrayParamEx,exports.isFileAttr=s.isFileAttr,exports.isNumberArrayParam=s.isNumberArrayParam,exports.isNumberAttr=s.isNumberAttr,exports.isNumberValueParam=s.isNumberValueParam,exports.isNumberValueParamEx=s.isNumberValueParamEx,exports.isScalarParam=s.isScalarParam,exports.isStringArrayParam=s.isStringArrayParam,exports.isStringValueParam=s.isStringValueParam,exports.isStructArrayAttr=s.isStructArrayAttr,exports.isStructArrayParam=s.isStructArrayParam,exports.isStructAttr=s.isStructAttr,exports.isStructParam=s.isStructParam,exports.isVariableAttr=s.isVariableAttr,exports.paramHasText=s.paramHasText,exports.toArrayPluginParam=s.toArrayPluginParam,exports.toObjectPluginParams=s.toObjectPluginParams,exports.toObjectPluginParamsOld=s.toObjectPluginParamsOld,exports.FILENAME_ACTORS="Actors.json",exports.FILENAME_ANIMATIONS="Animations.json",exports.FILENAME_ARMORS="Armors.json",exports.FILENAME_CLASSES="Classes.json",exports.FILENAME_COMMON_EVENTS="CommonEvents.json",exports.FILENAME_ENEMIES="Enemies.json",exports.FILENAME_ITEMS="Items.json",exports.FILENAME_MAP_INFOS="MapInfos.json",exports.FILENAME_SKILLS="Skills.json",exports.FILENAME_STATES="States.json",exports.FILENAME_SYSTEM="System.json",exports.FILENAME_TILESET="Tilesets.json",exports.FILENAME_TROOPS="Troops.json",exports.FILENAME_WEAPONS="Weapons.json",exports.FOLDER_AUDIO="audio",exports.FOLDER_AUDIO_BGM="bgm",exports.FOLDER_AUDIO_BGS="bgs",exports.FOLDER_AUDIO_ME="me",exports.FOLDER_AUDIO_SE="se",exports.FOLDER_DATA="data",exports.FOLDER_IMG="img",exports.FOLDER_IMG_BATTLEBACK1="battlebacks1",exports.FOLDER_IMG_BATTLEBACK2="battlebacks2",exports.FOLDER_IMG_CHACTERS="characters",exports.FOLDER_IMG_ENEMIES="enemies",exports.FOLDER_IMG_FACES="faces",exports.FOLDER_IMG_PARALLACES="parallaxes",exports.FOLDER_IMG_PICTURES="pictures",exports.FOLDER_IMG_SV_ACTORS="sv_actors",exports.FOLDER_IMG_SV_ENEMIES="sv_enemies",exports.FOLDER_IMG_SYSTEM="system",exports.FOLDER_IMG_TILESETS="tilesets",exports.FOLDER_IMG_TITLES1="titles1",exports.FOLDER_IMG_TITLES2="titles2",exports.FOLDER_JS="js",exports.collectDependentStructNames=U,exports.compileAttributes=C,exports.convertPluginsJSToJSON=X,exports.filterPluginParamByText=r=>S(r,s.hasTextAttr),exports.filterPluginSchemaByFileParam=r=>S(r,s.isFileAttr),exports.filterPluginSchemaByNumberParam=r=>S(r,s.isNumberAttr),exports.filterPluginSchemaByParam=S,exports.filterPluginSchemaByVariableParam=r=>S(r,s.isVariableAttr),exports.isRmmzDataKind=r=>{const e=R(r.kind);return e.author===r.author&&e.module===r.module&&e.kind===r.kind},exports.lookupKind=R,exports.parseDeepJSON=P,exports.parseDeepRecord=k,exports.parsePluginParamObject=r=>V(r).map(e=>({description:e.description,name:e.name,status:e.status,parameters:k(e.parameters)})),exports.parsePluginParamRecord=V,exports.pluginSourceToArraySchema=(r,e)=>{const t=J(e);return{meta:t.meta,pluginName:r,target:"MZ",schema:(a=t,{commands:Mr(a.commands),params:j(a.params),structs:Fr(a.structs)})};var a},exports.pluginSourceToJSON=r=>(e=>Nr(J(e)))(r),exports.rebuildCommands=z,exports.stringifyDeepJSON=r=>JSON.stringify(cr(r)),exports.structDependencies=(r,e)=>K(r,e,new Set),exports.validatePluginJS=Q;
