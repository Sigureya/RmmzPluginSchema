"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const n=require("../shared/parseDeepJSON.cjs.js"),B=(t,e)=>{const r=function(a){return Object.fromEntries(a.map(s=>[s.struct,s.params.filter(n.hasStructAttr)]))}(t);return function(a,s,o){return a.reduce(m=>{if(!m.changed)return m;const l=a.filter(f=>!m.names.has(f)&&s[f].some(i=>m.names.has(i.attr.struct)));return l.length===0?{names:m.names,changed:!1}:{names:new Set([...m.names,...l]),changed:!0}},{names:o,changed:!0}).names}(Object.keys(r),r,new Set(e))},S=(t,e)=>{const r=t.structs.filter(o=>o.params.some(m=>e(m))),a=new Set(r.map(o=>o.struct)),s=B(t.structs,a);return{structs:Q(t.structs,s,e),commands:J(t.commands,s,e),params:L(t.params,s,e)}},L=(t,e,r)=>t.filter(a=>n.hasStructAttr(a)?e.has(a.attr.struct):r(a)),Q=(t,e,r)=>t.map(a=>({struct:a.struct,params:L(a.params,e,r)})).filter(a=>a.params.length>0),J=(t,e,r)=>t.map(a=>({...a.desc?{desc:a.desc}:{},...a.text?{text:a.text}:{},command:a.command,args:L(a.args,e,r)})).filter(a=>a.args.length>0),X={variable:1,switch:2,actor:0,item:0,weapon:0,armor:0,skill:0,class:0,state:0,troop:0,enemy:0,common_event:0},tt=["data","system","system"],x=t=>{const e=X[t];return e===void 0?{author:"rmmz",module:"unknown",kind:t}:{author:"rmmz",module:tt[e],kind:[t,"variable","switch"][e]}},G=(t,e,r)=>{const a=e.get(t);return a?a.filter(s=>((o,m)=>!(!n.isStructParam(o)&&!n.isStructArrayParam(o)||!o.struct||m.has(o.struct)))(s,r)).flatMap(s=>{const o=s.struct;return r.add(o),[o,...G(o,e,r)]}):[]},P=t=>typeof t=="object"&&t!==null&&!Array.isArray(t),C=t=>Array.isArray(t)?et(t):P(t)?g(t):{},g=t=>P(t)?Object.fromEntries(Object.entries(t).map(([e,r])=>{if(Array.isArray(r)){const a=r.map(s=>P(s)?JSON.stringify(g(s)):String(s));return[e,JSON.stringify(a)]}return P(r)?[e,JSON.stringify(g(r))]:[e,String(r)]})):{},et=t=>t.map(e=>typeof e=="object"&&e!==null?JSON.stringify(g(e)):String(e)),V=(t,e)=>Object.entries(e).reduce((r,[a,s])=>{if(a in t){const o=t[a];if(typeof o=="string")return{...r,[a]:s(o)}}return r},{}),A=(t,e,r,a)=>({default:e,...V(r,a),kind:t}),y=(t,e,r)=>({default:[],...V(e,r),kind:t}),rt=(t,e)=>{const r=t.map(a=>a.locale===void 0?a.struct:a.locale===e?`${a.struct}!`:"");return new Set(r)},U="BODY",z="STRUCT",E="NONE",at=(t,e)=>{const r=e.trim(),a=r.match(/^\/\*~struct~([A-Za-z0-9_]*)(?::([A-Za-z0-9_-]+))?/);return a?nt(t,a):/^\/\*:/.test(r)?ct(t,r):r==="*/"?t.lines.length>0?v(t):t:{...t,lines:t.lines.concat([r])}},nt=(t,e)=>{const r=t.lines.length>0?v(t):t,a=e[1]||void 0;return{...r,structName:a,blockType:a?z:"INVALID",locale:e[2],lines:[]}},st=t=>{if(t){const e=t.match(/^\/\*:(\w+)/);if(e)return e[1]}},ct=(t,e)=>({...t.lines.length>0?v(t):t,locale:st(e),blockType:U,lines:[]}),v=t=>{if(t.blockType===U){const e=t.locale?{locale:t.locale,lines:[...t.lines]}:{lines:[...t.lines]};return{...t,bodies:t.bodies.concat([e]),lines:[],blockType:E,locale:void 0}}return t.structName&&t.blockType===z?{...t,structs:t.structs.concat([{struct:t.structName,locale:t.locale,lines:[...t.lines]}]),blockType:E,structName:void 0,locale:void 0,lines:[]}:{...t,blockType:E,structName:void 0,locale:void 0,lines:[]}},ot=t=>t.currentOption?{items:t.items.concat({option:t.currentOption,value:t.currentOption})}:t,K="help",N="kind",h="text",D="struct",M=t=>{if(N in t.attr){const e=mt[t.attr.kind];if(e)return e(t)}return A("any","",t.attr,b)},c=t=>t,W=t=>t.replace("[","").replace("]","").split(",").map(e=>parseFloat(e.replaceAll('"',"").trim())).filter(e=>!isNaN(e)),b={default:c,text:c,desc:c,parent:c},j=t=>A("string","",t.attr,b),R=t=>{const e={default:r=>n.parseDeepJSON(r),text:c,desc:c,parent:c};return y("string[]",t.attr,e)},p=(t,e)=>{const r={default:W,text:c,desc:c,parent:c};return y(e,t.attr,r)},d=(t,e)=>{const r={default:a=>parseInt(a,10),text:c,desc:c,parent:c};return A(e,0,t.attr,r)},mt={number:t=>(e=>{const r={default:a=>parseFloat(a),text:c,desc:c,decimals:a=>parseInt(a,10),min:a=>parseFloat(a),max:a=>parseFloat(a),parent:c};return A("number",0,e.attr,r)})(t),"number[]":t=>{const e={default:W,text:c,desc:c,decimals:r=>parseInt(r,10),min:r=>parseFloat(r),max:r=>parseFloat(r),parent:c};return y("number[]",t.attr,e)},string:j,"string[]":R,multiline_string:j,"multiline_string[]":R,combo:t=>{var r;const e=((r=t.options)==null?void 0:r.map(a=>a.option))??[];return{...A("combo","",t.attr,b),options:e}},select:t=>{var r;const e=((r=t.options)==null?void 0:r.map(a=>({option:a.option,value:a.value})))??[];return{...A("select","",t.attr,b),options:e}},actor:t=>d(t,"actor"),"actor[]":t=>p(t,"actor[]"),class:t=>d(t,"class"),"class[]":t=>p(t,"class[]"),skill:t=>d(t,"skill"),"skill[]":t=>p(t,"skill[]"),item:t=>d(t,"item"),"item[]":t=>p(t,"item[]"),weapon:t=>d(t,"weapon"),"weapon[]":t=>p(t,"weapon[]"),armor:t=>d(t,"armor"),"armor[]":t=>p(t,"armor[]"),state:t=>d(t,"state"),"state[]":t=>p(t,"state[]"),enemy:t=>d(t,"enemy"),"enemy[]":t=>p(t,"enemy[]"),common_event:t=>d(t,"common_event"),"common_event[]":t=>p(t,"common_event[]"),switch:t=>d(t,"switch"),"switch[]":t=>p(t,"switch[]"),variable:t=>d(t,"variable"),"variable[]":t=>p(t,"variable[]"),troop:t=>d(t,"troop"),"troop[]":t=>p(t,"troop[]"),boolean:t=>{const e={default:r=>r==="true",text:c,desc:c,on:c,off:c,parent:c};return A("boolean",!0,t.attr,e)},file:t=>{const e={default:c,text:c,desc:c,parent:c,dir:c};return{dir:"",...A("file","",t.attr,e)}},"file[]":t=>{const e={default:r=>n.parseDeepJSON(r),text:c,desc:c,parent:c,dir:c};return{dir:"",...y("file[]",t.attr,e)}},struct:t=>{const e=(a=>{if(!a.attr.default)return{};const s=n.parseDeepJSON(a.attr.default);return Array.isArray(s)?{}:typeof s=="object"&&s!==null?s:{}})(t),r={text:c,desc:c,parent:c};return{struct:t.attr.struct||"",...A("struct",e,t.attr,r)}},"struct[]":t=>{const e=(a=>{if(!a.attr.default)return[];const s=n.parseDeepJSON(a.attr.default);return Array.isArray(s)&&s.every(o=>typeof o=="object"&&o!==null)?s:[]})(t),r={text:c,desc:c,parent:c};return{struct:t.attr.struct||"",...A("struct[]",e,t.attr,r),default:e}}},$=t=>!Array.isArray(t)&&typeof t=="object"&&t!==null&&!!(it(t)&&ut(t)&&lt(t)&&"parameters"in t)&&pt(t),it=t=>"name"in t&&typeof t.name=="string",ut=t=>"status"in t&&typeof t.status=="boolean",lt=t=>"description"in t&&typeof t.description=="string",pt=t=>typeof t.parameters=="object"&&t.parameters!==null&&Object.values(t.parameters).every(e=>typeof e=="string"),dt=/\s*\/\//,ft=/\s*[var|let|const]\s+[^\s]+\s*=/,At=/^\s{0,3}[\[|\]\;]/,Z=t=>t.split(`
`).filter(e=>!(r=>dt.test(r)||At.test(r)||ft.test(r))(e)),k=t=>{const e=`[${Z(t).join("")}]`,r=JSON.parse(e);if(!Array.isArray(r))throw new Error("Parsed value is not an array");if(r.every($))return r;throw new Error("Parsed value is not PluginParamsObject array")},St=(t,e)=>{const r=e.get(t.name);if(!r)return t.parameters;const a=Object.entries(t.parameters).filter(([s])=>!r.has(s));return Object.fromEntries(a)},Pt=t=>new Map(t.map(e=>[e.pluginName,new Set(e.params)])),I=t=>({...typeof t.desc=="string"?{desc:t.desc}:{},...typeof t.text=="string"?{text:t.text}:{}}),O=t=>{const e=Et(t),r=gt(e);return Ot(r)},Et=t=>{if(t.currentParam&&t.currentOption){const e=t.currentParam.attr.kind;if(e==="select"||e==="combo")return{...t,currentParam:{...t.currentParam,options:ot(t.currentOption).items}}}return t},Ot=t=>t.currentParam?{...t,params:[...t.params,t.currentParam],currentParam:null,currentContext:null}:t,gt=t=>{if(!t.currentCommand)return t;const e=t.currentParam?[...t.currentCommand.args,t.currentParam]:t.currentCommand.args,r={...I(t.currentCommand),command:t.currentCommand.command,args:e};return{...t,commands:[...t.commands,r],currentCommand:null,currentParam:null,currentContext:null,currentOption:null}},w=(t,e="en")=>{const r=(m=>{const l=m.split(`
`),f={structs:[],bodies:[],structName:void 0,locale:void 0,lines:[],blockType:E},i=l.reduce((Y,q)=>at(Y,q),f);return{structs:i.structs,bodies:i.bodies}})(t),a=((m,l)=>{const f=rt(m,l);return m.filter(i=>i.locale===void 0&&f.has(i.struct)?!f.has(`${i.struct}!`):i.locale===l&&f.has(`${i.struct}!`))})(r.structs,e).map(m=>yt(m)),s=((m,l)=>m.reduce((f,i)=>i.locale===l||i.locale===void 0&&f===void 0?i:f,void 0))(r.bodies,e);if(!s)return{params:[],commands:[],meta:{},helpLines:[],structs:a};const o=H(s);return{params:o.params,commands:o.commands,meta:o.meta,helpLines:o.helpLines,structs:a,dependencies:o.dependencies}},yt=t=>{const e=H(t);return{name:t.struct,params:e.params}},H=t=>{const e=t.lines.reduce((r,a)=>ht(r,a),bt());return O(e)},bt=()=>({helpLines:[],params:[],commands:[],currentParam:null,currentCommand:null,currentContext:null,currentOption:null,dependencies:{base:[],orderBefore:[],orderAfter:[]},meta:{}}),ht=(t,e,r=_t)=>{const a=e.trimEnd().replace(/^[\*\s]*/,"");if(!a.startsWith("@"))return t.currentContext===K?{...t,helpLines:t.helpLines.concat(a)}:t;const s=a.match(/^@(\S+)\s*(.*)$/);if(!s)return t;const[,o,m]=s,l=r[o];return l?l(t,m.trim()):t},u=(t,e,r)=>t.currentParam&&!(e in t.currentParam.attr)?{...t,currentParam:{...t.currentParam,attr:{...t.currentParam.attr,[e]:r}}}:t,_=(t,e,r)=>({...t,meta:{[e]:r,...t.meta}}),_t={param:(t,e)=>{const r=O(t);return r.params.some(a=>a.name===e)?r:{...r,currentContext:"param",currentParam:{name:e,attr:{}}}},text:(t,e)=>t.currentParam?u(t,h,e):t.currentCommand&&!(h in t.currentCommand)?{...t,currentCommand:{...I(t.currentCommand),command:t.currentCommand.command,args:t.currentCommand.args,[h]:e}}:t,desc:(t,e)=>t.currentParam?u(t,"desc",e):t.currentCommand?{...t,currentCommand:{...t.currentCommand,desc:e}}:t,command:(t,e)=>{const r=O(t);return r.commands.some(a=>a.command===e)?r:{...r,currentCommand:{command:e,args:[]},currentParam:null}},arg:(t,e)=>{if(!t.currentCommand)return t;if(!t.currentParam)return{...t,currentParam:{name:e,attr:{}}};const r={...I(t.currentCommand),command:t.currentCommand.command,args:t.currentCommand.args.concat(t.currentParam)};return{...t,commands:t.commands,currentCommand:r,currentContext:"arg",currentParam:{name:e,attr:{}}}},help:t=>({...O(t),currentContext:K}),option:(t,e)=>{if(!t.currentParam)return t;const r=((a,s)=>a.currentOption?{items:a.items.concat({option:a.currentOption,value:a.currentOption}),currentOption:s}:{items:a.items,currentOption:s})(t.currentOption??{items:[]},e);return{...t,currentOption:r}},value:(t,e)=>{if(!t.currentOption)return t;const r=((a,s)=>a.currentOption?{items:a.items.concat({option:a.currentOption,value:s})}:{items:a.items})(t.currentOption,e);return{...t,currentOption:r}},type:(t,e)=>{if((r=>r.endsWith(">")&&r.startsWith("struct<"))(e)){const r=e.slice(7,-1),a=u(t,D,r);return u(a,N,D)}return t.currentParam?u(t,N,e):t},parent:(t,e)=>u(t,"parent",e),default:(t,e)=>u(t,"default",e),on:(t,e)=>u(t,"on",e),off:(t,e)=>u(t,"off",e),min:(t,e)=>u(t,"min",e),max:(t,e)=>u(t,"max",e),decimals:(t,e)=>u(t,"decimals",e),dir:(t,e)=>u(t,"dir",e),base:(t,e)=>{return{...t,dependencies:(r=t.dependencies,a=e,{orderAfter:r.orderAfter,orderBefore:r.orderBefore,base:r.base.concat(a)})};var r,a},orderAfter:(t,e)=>{return{...t,dependencies:(r=t.dependencies,a=e,{base:r.base,orderBefore:r.orderBefore,orderAfter:r.orderAfter.concat(a)})};var r,a},orderBefore:(t,e)=>{return{...t,dependencies:(r=t.dependencies,a=e,{base:r.base,orderAfter:r.orderAfter,orderBefore:r.orderBefore.concat(a)})};var r,a},author:(t,e)=>_(t,"author",e),plugindesc:(t,e)=>_(t,"plugindesc",e),url:(t,e)=>_(t,"url",e)},Nt=t=>({target:"MZ",meta:t.meta,commands:It(t.commands),params:F(t.params),structs:Lt(t.structs)}),F=t=>Object.fromEntries(t.map(e=>[e.name,M(e)])),It=t=>Object.fromEntries(t.map(e=>[e.command,{desc:e.desc,text:e.text,args:F(e.args)}])),Lt=t=>Object.fromEntries(t.map(e=>[e.name,{params:F(e.params)}])),T=t=>t.map(e=>({name:e.name,attr:M(e)})),vt=t=>t.map(e=>({command:e.command,desc:e.desc,text:e.text,args:T(e.args)})),Mt=t=>t.map(e=>({struct:e.name,params:T(e.params)}));exports.classifyFileParams=n.classifyFileParams,exports.classifyPluginParams=n.classifyPluginParams,exports.classifyTextParams=n.classifyTextParams,exports.convertPluginCommandSchema=n.convertPluginCommandSchema,exports.convertStructSchema=n.convertStructSchema,exports.createClassifiedStructMap=n.createClassifiedStructMap,exports.createStructMap=n.createStructMap,exports.hasNumberValueParam=n.hasNumberValueParam,exports.hasScalarAttr=n.hasScalarAttr,exports.hasStructAttr=n.hasStructAttr,exports.hasTextAttr=n.hasTextAttr,exports.isArrayAttr=n.isArrayAttr,exports.isArrayParam=n.isArrayParam,exports.isArrayParamEx=n.isArrayParamEx,exports.isFileAttr=n.isFileAttr,exports.isNumberArrayParam=n.isNumberArrayParam,exports.isNumberAttr=n.isNumberAttr,exports.isNumberValueParam=n.isNumberValueParam,exports.isNumberValueParamEx=n.isNumberValueParamEx,exports.isScalarParam=n.isScalarParam,exports.isStringArrayParam=n.isStringArrayParam,exports.isStringValueParam=n.isStringValueParam,exports.isStructArrayAttr=n.isStructArrayAttr,exports.isStructArrayParam=n.isStructArrayParam,exports.isStructAttr=n.isStructAttr,exports.isStructParam=n.isStructParam,exports.isVariableAttr=n.isVariableAttr,exports.paramHasText=n.paramHasText,exports.parseDeepJSON=n.parseDeepJSON,exports.parseDeepRecord=n.parseDeepRecord,exports.toArrayPluginParam=n.toArrayPluginParam,exports.toObjectPluginParams=n.toObjectPluginParams,exports.toObjectPluginParamsOld=n.toObjectPluginParamsOld,exports.FILENAME_ACTORS="Actors.json",exports.FILENAME_ANIMATIONS="Animations.json",exports.FILENAME_ARMORS="Armors.json",exports.FILENAME_CLASSES="Classes.json",exports.FILENAME_COMMON_EVENTS="CommonEvents.json",exports.FILENAME_ENEMIES="Enemies.json",exports.FILENAME_ITEMS="Items.json",exports.FILENAME_MAP_INFOS="MapInfos.json",exports.FILENAME_SKILLS="Skills.json",exports.FILENAME_STATES="States.json",exports.FILENAME_SYSTEM="System.json",exports.FILENAME_TILESET="Tilesets.json",exports.FILENAME_TROOPS="Troops.json",exports.FILENAME_WEAPONS="Weapons.json",exports.FOLDER_AUDIO="audio",exports.FOLDER_AUDIO_BGM="bgm",exports.FOLDER_AUDIO_BGS="bgs",exports.FOLDER_AUDIO_ME="me",exports.FOLDER_AUDIO_SE="se",exports.FOLDER_DATA="data",exports.FOLDER_IMG="img",exports.FOLDER_IMG_BATTLEBACK1="battlebacks1",exports.FOLDER_IMG_BATTLEBACK2="battlebacks2",exports.FOLDER_IMG_CHACTERS="characters",exports.FOLDER_IMG_ENEMIES="enemies",exports.FOLDER_IMG_FACES="faces",exports.FOLDER_IMG_PARALLACES="parallaxes",exports.FOLDER_IMG_PICTURES="pictures",exports.FOLDER_IMG_SV_ACTORS="sv_actors",exports.FOLDER_IMG_SV_ENEMIES="sv_enemies",exports.FOLDER_IMG_SYSTEM="system",exports.FOLDER_IMG_TILESETS="tilesets",exports.FOLDER_IMG_TITLES1="titles1",exports.FOLDER_IMG_TITLES2="titles2",exports.FOLDER_JS="js",exports.collectDependentStructNames=B,exports.compileAttributes=M,exports.convertPluginsJSToJSON=Z,exports.filterPluginParamByText=t=>S(t,n.hasTextAttr),exports.filterPluginSchemaByFileParam=t=>S(t,n.isFileAttr),exports.filterPluginSchemaByNumberParam=t=>S(t,n.isNumberAttr),exports.filterPluginSchemaByParam=S,exports.filterPluginSchemaByVariableParam=t=>S(t,n.isVariableAttr),exports.isRmmzDataKind=t=>{const e=x(t.kind);return e.author===t.author&&e.module===t.module&&e.kind===t.kind},exports.lookupKind=x,exports.omitPluginParam=(t,e)=>{const r=Pt(e);return t.map(a=>({description:a.description,name:a.name,status:a.status,parameters:St(a,r)}))},exports.parsePluginParamObject=t=>k(t).map(e=>({description:e.description,name:e.name,status:e.status,parameters:n.parseDeepRecord(e.parameters)})),exports.parsePluginParamRecord=k,exports.pluginSourceToArraySchema=t=>{const e=w(t.source,t.locale);return{meta:e.meta,pluginName:t.pluginName,target:"MZ",schema:(r=e,{commands:vt(r.commands),params:T(r.params),structs:Mt(r.structs)})};var r},exports.pluginSourceToJSON=t=>(e=>Nt(w(e)))(t),exports.rebuildCommands=J,exports.stringifyDeepJSON=t=>JSON.stringify(C(t)),exports.stringifyDeepRecord=t=>C(t),exports.structDependencies=(t,e)=>G(t,e,new Set),exports.validatePluginJS=$;
