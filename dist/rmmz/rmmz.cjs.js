"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const s=require("../shared/structMap.cjs.js"),z=(t,e)=>{const r=function(a){return Object.fromEntries(a.map(n=>[n.struct,n.params.filter(s.hasStructAttr)]))}(t);return function(a,n,m){return a.reduce(o=>{if(!o.changed)return o;const A=a.filter(f=>!o.names.has(f)&&n[f].some(i=>o.names.has(i.attr.struct)));return A.length===0?{names:o.names,changed:!1}:{names:new Set([...o.names,...A]),changed:!0}},{names:m,changed:!0}).names}(Object.keys(r),r,new Set(e))},S=(t,e)=>{const r=t.structs.filter(m=>m.params.some(o=>e(o))),a=new Set(r.map(m=>m.struct)),n=z(t.structs,a);return{structs:rt(t.structs,n,e),commands:K(t.commands,n,e),params:F(t.params,n,e)}},F=(t,e,r)=>t.filter(a=>s.hasStructAttr(a)?e.has(a.attr.struct):r(a)),rt=(t,e,r)=>t.reduce((a,n)=>{const m=F(n.params,e,r);return m.length===0||a.push({struct:n.struct,params:m}),a},[]),K=(t,e,r)=>t.reduce((a,n)=>{const m=F(n.args,e,r);return m.length===0||a.push({...n.desc?{desc:n.desc}:{},...n.text?{text:n.text}:{},command:n.command,args:m}),a},[]),at={variable:1,switch:2,actor:0,item:0,weapon:0,armor:0,skill:0,class:0,state:0,troop:0,enemy:0,common_event:0},nt=["data","system","system"],R=t=>{const e=at[t];return e===void 0?{author:"rmmz",module:"unknown",kind:t}:{author:"rmmz",module:nt[e],kind:[t,"variable","switch"][e]}},W=(t,e,r)=>{const a=e.get(t);return a?a.filter(n=>((m,o)=>!(!s.isStructParam(m)&&!s.isStructArrayParam(m)||!m.struct||o.has(m.struct)))(n,r)).flatMap(n=>{const m=n.struct;return r.add(m),[m,...W(m,e,r)]}):[]},C=t=>{const e=JSON.parse(t);return Array.isArray(e)?e.map(y):typeof e=="object"&&e!==null?Z(e):e},k=t=>Z(t),Z=t=>Object.fromEntries(Object.entries(t).map(([e,r])=>[e,y(r)])),y=t=>{if(typeof t!="string")return t;try{const e=JSON.parse(t);return Array.isArray(e)?e.map(y):typeof e=="object"&&e!==null?Object.fromEntries(Object.entries(e).map(([r,a])=>[r,y(a)])):e}catch{return t}},P=t=>typeof t=="object"&&t!==null&&!Array.isArray(t),st=t=>Array.isArray(t)?ct(t):P(t)?g(t):{},g=t=>P(t)?Object.fromEntries(Object.entries(t).map(([e,r])=>{if(Array.isArray(r)){const a=r.map(n=>P(n)?JSON.stringify(g(n)):String(n));return[e,JSON.stringify(a)]}return P(r)?[e,JSON.stringify(g(r))]:[e,String(r)]})):{},ct=t=>t.map(e=>typeof e=="object"&&e!==null?JSON.stringify(g(e)):String(e)),H=(t,e)=>Object.entries(e).reduce((r,[a,n])=>{if(a in t){const m=t[a];if(typeof m=="string")return{...r,[a]:n(m)}}return r},{}),p=(t,e,r,a)=>({default:e,...H(r,a),kind:t}),h=(t,e,r)=>({default:[],...H(e,r),kind:t}),Y="BODY",$="STRUCT",O="NONE",mt=(t,e)=>{const r=t.lines.length>0?T(t):t,a=e[1]||void 0;return{...r,structName:a,blockType:a?$:"INVALID",locale:e[2],lines:[]}},ot=t=>({...t.lines.length>0?T(t):t,blockType:Y,structName:void 0,locale:void 0,lines:[]}),T=t=>t.blockType===Y?{...t,bodies:t.bodies.concat([{lines:[...t.lines]}]),lines:[],blockType:O}:t.structName&&t.blockType===$?{...t,structs:t.structs.concat([{struct:t.structName,locale:t.locale,lines:[...t.lines]}]),blockType:O,structName:void 0,locale:void 0,lines:[]}:{...t,blockType:O,structName:void 0,lines:[]},it=t=>t.currentOption?{items:t.items.concat({option:t.currentOption,value:t.currentOption})}:t,q="help",L="kind",N="text",w="struct",v=t=>{if(L in t.attr){const e=ut[t.attr.kind];if(e)return e(t)}return p("any","",t.attr,_)},c=t=>t,Q=t=>t.replace("[","").replace("]","").split(",").map(e=>parseFloat(e.replaceAll('"',"").trim())).filter(e=>!isNaN(e)),_={default:c,text:c,desc:c,parent:c},B=t=>p("string","",t.attr,_),G=t=>{const e={default:r=>C(r),text:c,desc:c,parent:c};return h("string[]",t.attr,e)},u=(t,e)=>{const r={default:Q,text:c,desc:c,parent:c};return h(e,t.attr,r)},l=(t,e)=>{const r={default:a=>parseInt(a,10),text:c,desc:c,parent:c};return p(e,0,t.attr,r)},ut={number:t=>(e=>{const r={default:a=>parseFloat(a),text:c,desc:c,decimals:a=>parseInt(a,10),min:a=>parseFloat(a),max:a=>parseFloat(a),parent:c};return p("number",0,e.attr,r)})(t),"number[]":t=>{const e={default:Q,text:c,desc:c,decimals:r=>parseInt(r,10),min:r=>parseFloat(r),max:r=>parseFloat(r),parent:c};return h("number[]",t.attr,e)},string:B,"string[]":G,multiline_string:B,"multiline_string[]":G,combo:t=>{var r;const e=((r=t.options)==null?void 0:r.map(a=>a.option))??[];return{...p("combo","",t.attr,_),options:e}},select:t=>{var r;const e=((r=t.options)==null?void 0:r.map(a=>({option:a.option,value:a.value})))??[];return{...p("select","",t.attr,_),options:e}},actor:t=>l(t,"actor"),"actor[]":t=>u(t,"actor[]"),class:t=>l(t,"class"),"class[]":t=>u(t,"class[]"),skill:t=>l(t,"skill"),"skill[]":t=>u(t,"skill[]"),item:t=>l(t,"item"),"item[]":t=>u(t,"item[]"),weapon:t=>l(t,"weapon"),"weapon[]":t=>u(t,"weapon[]"),armor:t=>l(t,"armor"),"armor[]":t=>u(t,"armor[]"),state:t=>l(t,"state"),"state[]":t=>u(t,"state[]"),enemy:t=>l(t,"enemy"),"enemy[]":t=>u(t,"enemy[]"),common_event:t=>l(t,"common_event"),"common_event[]":t=>u(t,"common_event[]"),switch:t=>l(t,"switch"),"switch[]":t=>u(t,"switch[]"),variable:t=>l(t,"variable"),"variable[]":t=>u(t,"variable[]"),troop:t=>l(t,"troop"),"troop[]":t=>u(t,"troop[]"),boolean:t=>{const e={default:r=>r==="true",text:c,desc:c,on:c,off:c,parent:c};return p("boolean",!0,t.attr,e)},file:t=>{const e={default:c,text:c,desc:c,parent:c,dir:c};return{dir:"",...p("file","",t.attr,e)}},"file[]":t=>{const e={default:r=>C(r),text:c,desc:c,parent:c,dir:c};return{dir:"",...h("file[]",t.attr,e)}}},V=t=>!Array.isArray(t)&&typeof t=="object"&&t!==null&&!!(lt(t)&&dt(t)&&pt(t)&&"parameters"in t)&&ft(t),lt=t=>"name"in t&&typeof t.name=="string",dt=t=>"status"in t&&typeof t.status=="boolean",pt=t=>"description"in t&&typeof t.description=="string",ft=t=>typeof t.parameters=="object"&&t.parameters!==null&&Object.values(t.parameters).every(e=>typeof e=="string"),At=/\s*\/\//,St=/\s*[var|let|const]\s+\$plugins\s*=\s*/,Et=/^\s*[\[\]]/,J=t=>t.split(`
`).filter(e=>!(r=>At.test(r)||St.test(r)||Et.test(r))(e)),M=t=>({...typeof t.desc=="string"?{desc:t.desc}:{},...typeof t.text=="string"?{text:t.text}:{}}),b=t=>{const e=Pt(t),r=bt(e);return Ot(r)},Pt=t=>{if(t.currentParam&&t.currentOption){const e=t.currentParam.attr.kind;if(e==="select"||e==="combo")return{...t,currentParam:{...t.currentParam,options:it(t.currentOption).items}}}return t},Ot=t=>t.currentParam?{...t,params:[...t.params,t.currentParam],currentParam:null,currentContext:null}:t,bt=t=>{if(!t.currentCommand)return t;const e=t.currentParam?[...t.currentCommand.args,t.currentParam]:t.currentCommand.args,r={...M(t.currentCommand),command:t.currentCommand.command,args:e};return{...t,commands:[...t.commands,r],currentCommand:null,currentParam:null,currentContext:null,currentOption:null}},U=t=>{const e=(m=>{const o=m.split(`
`),A={structs:[],bodies:[],structName:void 0,locale:void 0,lines:[],blockType:O},f=o.reduce((i,et)=>{const E=et.trim(),D=E.match(/^\/\*~struct~([A-Za-z0-9_]+)(?::([A-Za-z0-9_-]+))?/);return D?mt(i,D):E==="/*:"?ot(i):E==="*/"?i.lines.length>0?T(i):i:{...i,lines:i.lines.concat([E])}},A);return{structs:f.structs,bodies:f.bodies}})(t),r=e.structs.map(m=>yt(m)),a=gt(e);if(!a)return{params:[],commands:[],meta:{},helpLines:[],structs:r};const n=X(a,tt);return{params:n.params,commands:n.commands,meta:n.meta,helpLines:n.helpLines,structs:r}},yt=t=>{const e=X(t,tt);return{name:t.struct,params:e.params}},gt=t=>{if(t.bodies.length!==0)return t.bodies[0]},X=(t,e)=>{const r=t.lines.reduce((a,n)=>{const m=n.trimEnd().replace(/^[\*\s]*/,"");if(!m.startsWith("@"))return a.currentContext===q?{...a,helpLines:a.helpLines.concat(m)}:a;const o=m.match(/^@(\S+)\s*(.*)$/);if(!o)return a;const[,A,f]=o,i=e[A];return i?i(a,f.trim()):a},ht());return b(r)},ht=()=>({helpLines:[],params:[],commands:[],currentParam:null,currentCommand:null,currentContext:null,currentOption:null,dependencies:{base:[],orderBefore:[],orderAfter:[]},meta:{}}),d=(t,e,r)=>t.currentParam&&!(e in t.currentParam.attr)?{...t,currentParam:{...t.currentParam,attr:{...t.currentParam.attr,[e]:r}}}:t,I=(t,e,r)=>({...t,meta:{[e]:r,...t.meta}}),tt={param:(t,e)=>{const r=b(t);return r.params.some(a=>a.name===e)?r:{...r,currentContext:"param",currentParam:{name:e,attr:{}}}},text:(t,e)=>t.currentParam?d(t,N,e):t.currentCommand&&!(N in t.currentCommand)?{...t,currentCommand:{...M(t.currentCommand),command:t.currentCommand.command,args:t.currentCommand.args,[N]:e}}:t,desc:(t,e)=>t.currentParam?d(t,"desc",e):t.currentCommand?{...t,currentCommand:{...t.currentCommand,desc:e}}:t,command:(t,e)=>{const r=b(t);return r.commands.some(a=>a.command===e)?r:{...r,currentCommand:{command:e,args:[]},currentParam:null}},arg:(t,e)=>{if(!t.currentCommand)return t;if(!t.currentParam)return{...t,currentParam:{name:e,attr:{}}};const r={...M(t.currentCommand),command:t.currentCommand.command,args:t.currentCommand.args.concat(t.currentParam)};return{...t,commands:t.commands,currentCommand:r,currentContext:"arg",currentParam:{name:e,attr:{}}}},help:t=>({...b(t),currentContext:q}),option:(t,e)=>{if(!t.currentParam)return t;const r=((a,n)=>a.currentOption?{items:a.items.concat({option:a.currentOption,value:a.currentOption}),currentOption:n}:{items:a.items,currentOption:n})(t.currentOption??{items:[]},e);return{...t,currentOption:r}},value:(t,e)=>{if(!t.currentOption)return t;const r=((a,n)=>a.currentOption?{items:a.items.concat({option:a.currentOption,value:n})}:{items:a.items})(t.currentOption,e);return{...t,currentOption:r}},type:(t,e)=>{if((r=>r.endsWith(">")&&r.startsWith("struct<"))(e)){const r=e.slice(7,-1),a=d(t,w,r);return d(a,L,w)}return t.currentParam?d(t,L,e):t},default:(t,e)=>d(t,"default",e),on:(t,e)=>d(t,"on",e),off:(t,e)=>d(t,"off",e),min:(t,e)=>d(t,"min",e),max:(t,e)=>d(t,"max",e),base:(t,e)=>{return{...t,dependencies:(r=t.dependencies,a=e,{orderAfter:r.orderAfter,orderBefore:r.orderBefore,base:r.base.concat(a)})};var r,a},orderAfter:(t,e)=>{return{...t,dependencies:(r=t.dependencies,a=e,{base:r.base,orderBefore:r.orderBefore,orderAfter:r.orderAfter.concat(a)})};var r,a},orderBefore:(t,e)=>{return{...t,dependencies:(r=t.dependencies,a=e,{base:r.base,orderAfter:r.orderAfter,orderBefore:r.orderBefore.concat(a)})};var r,a},author:(t,e)=>I(t,"author",e),plugindesc:(t,e)=>I(t,"plugindesc",e),url:(t,e)=>I(t,"url",e)},_t=t=>({target:"MZ",meta:t.meta,commands:Nt(t.commands),params:x(t.params),structs:It(t.structs)}),x=t=>Object.fromEntries(t.map(e=>[e.name,v(e)])),Nt=t=>Object.fromEntries(t.map(e=>[e.command,{desc:e.desc,text:e.text,args:x(e.args)}])),It=t=>Object.fromEntries(t.map(e=>[e.name,{params:x(e.params)}])),j=t=>t.map(e=>({name:e.name,attr:v(e)})),Lt=t=>t.map(e=>({command:e.command,desc:e.desc,text:e.text,args:j(e.args)})),Mt=t=>t.map(e=>({struct:e.name,params:j(e.params)}));exports.classifyFileParams=s.classifyFileParams,exports.classifyPluginParams=s.classifyPluginParams,exports.classifyTextParams=s.classifyTextParams,exports.convertPluginCommandSchema=s.convertPluginCommandSchema,exports.convertStructSchema=s.convertStructSchema,exports.createClassifiedStructMap=s.createClassifiedStructMap,exports.createStructMap=s.createStructMap,exports.hasNumberValueParam=s.hasNumberValueParam,exports.hasScalarAttr=s.hasScalarAttr,exports.hasStructAttr=s.hasStructAttr,exports.hasTextAttr=s.hasTextAttr,exports.isArrayAttr=s.isArrayAttr,exports.isArrayParam=s.isArrayParam,exports.isArrayParamEx=s.isArrayParamEx,exports.isFileAttr=s.isFileAttr,exports.isNumberArrayParam=s.isNumberArrayParam,exports.isNumberAttr=s.isNumberAttr,exports.isNumberValueParam=s.isNumberValueParam,exports.isNumberValueParamEx=s.isNumberValueParamEx,exports.isScalarParam=s.isScalarParam,exports.isStringArrayParam=s.isStringArrayParam,exports.isStringValueParam=s.isStringValueParam,exports.isStructArrayAttr=s.isStructArrayAttr,exports.isStructArrayParam=s.isStructArrayParam,exports.isStructAttr=s.isStructAttr,exports.isStructParam=s.isStructParam,exports.isVariableAttr=s.isVariableAttr,exports.paramHasText=s.paramHasText,exports.toArrayPluginParam=s.toArrayPluginParam,exports.toObjectPluginParams=s.toObjectPluginParams,exports.toObjectPluginParamsOld=s.toObjectPluginParamsOld,exports.FILENAME_ACTORS="Actors.json",exports.FILENAME_ANIMATIONS="Animations.json",exports.FILENAME_ARMORS="Armors.json",exports.FILENAME_CLASSES="Classes.json",exports.FILENAME_COMMON_EVENTS="CommonEvents.json",exports.FILENAME_ENEMIES="Enemies.json",exports.FILENAME_ITEMS="Items.json",exports.FILENAME_MAP_INFOS="MapInfos.json",exports.FILENAME_SKILLS="Skills.json",exports.FILENAME_STATES="States.json",exports.FILENAME_SYSTEM="System.json",exports.FILENAME_TILESET="Tilesets.json",exports.FILENAME_TROOPS="Troops.json",exports.FILENAME_WEAPONS="Weapons.json",exports.FOLDER_AUDIO="audio",exports.FOLDER_AUDIO_BGM="bgm",exports.FOLDER_AUDIO_BGS="bgs",exports.FOLDER_AUDIO_ME="me",exports.FOLDER_AUDIO_SE="se",exports.FOLDER_DATA="data",exports.FOLDER_IMG="img",exports.FOLDER_IMG_BATTLEBACK1="battlebacks1",exports.FOLDER_IMG_BATTLEBACK2="battlebacks2",exports.FOLDER_IMG_CHACTERS="characters",exports.FOLDER_IMG_ENEMIES="enemies",exports.FOLDER_IMG_FACES="faces",exports.FOLDER_IMG_PARALLACES="parallaxes",exports.FOLDER_IMG_PICTURES="pictures",exports.FOLDER_IMG_SV_ACTORS="sv_actors",exports.FOLDER_IMG_SV_ENEMIES="sv_enemies",exports.FOLDER_IMG_SYSTEM="system",exports.FOLDER_IMG_TILESETS="tilesets",exports.FOLDER_IMG_TITLES1="titles1",exports.FOLDER_IMG_TITLES2="titles2",exports.FOLDER_JS="js",exports.collectDependentStructNames=z,exports.compileAttributes=v,exports.convertPluginsJSToJSON=J,exports.filterPluginSchemaByFileParam=t=>S(t,s.isFileAttr),exports.filterPluginSchemaByNumberParam=t=>S(t,s.isNumberAttr),exports.filterPluginSchemaByParam=S,exports.filterPluginSchemaByStringParam=t=>S(t,s.hasTextAttr),exports.filterPluginSchemaByVariableParam=t=>S(t,s.isVariableAttr),exports.isRmmzDataKind=t=>{const e=R(t.kind);return e.author===t.author&&e.module===t.module&&e.kind===t.kind},exports.lookupKind=R,exports.parseDeepJSON=C,exports.parseDeepRecord=k,exports.parsePluginParamObject=t=>(e=>{const r=`[${J(e).join("")}]`,a=JSON.parse(r);if(!Array.isArray(a))throw new Error("Parsed value is not an array");if(a.every(V))return a;throw new Error("Parsed value is not PluginParamsObject array")})(t).map(e=>({description:e.description,name:e.name,status:e.status,parameters:k(e.parameters)})),exports.pluginSourceToArraySchema=(t,e)=>{const r=U(e);return{meta:r.meta,pluginName:t,target:"MZ",schema:(a=r,{commands:Lt(a.commands),params:j(a.params),structs:Mt(a.structs)})};var a},exports.pluginSourceToJSON=t=>(e=>_t(U(e)))(t),exports.rebuildCommands=K,exports.stringifyDeepJSON=t=>JSON.stringify(st(t)),exports.structDependencies=(t,e)=>W(t,e,new Set),exports.validatePluginJS=V;
